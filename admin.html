---
layout: default
title: Admin - Edit Posts
---

<div class="admin-interface">
    <h1>Coffee Posts Admin</h1>
    <p>Edit post metadata - changes are saved to a corrections file and won't be overwritten by the script.</p>
    
    <div class="search-filters">
        <input type="text" id="search-input" placeholder="Search posts..." class="search-input">
        <select id="continent-filter" class="filter-select">
            <option value="">All Continents</option>
        </select>
        <select id="country-filter" class="filter-select">
            <option value="">All Countries</option>
        </select>
        <label class="checkbox-label">
            <input type="checkbox" id="show-problematic" class="checkbox-input">
            Show Problematic Only
        </label>
        <button onclick="exportCorrections()" class="btn btn-primary">Export Corrections</button>
    </div>
    
    <div class="stats">
        <span id="total-posts">0</span> total posts | 
        <span id="no-location">0</span> missing location | 
        <span id="no-cafe">0</span> missing cafe name
    </div>
    
    <!-- Tools Section -->
    <div class="tools-section">
        <h2>üìù Apply Your Edits</h2>
        <p class="tools-description">After editing posts above, use these tools to save your changes permanently:</p>
        
        <div class="workflow-buttons">
            <button id="save-and-apply-btn" class="btn btn-primary">üíæ Save & Apply Changes</button>
            <button id="full-reprocess-btn" class="btn btn-warning">üîÑ Get Reprocess Command</button>
        </div>
        
        <div id="save-and-apply-command" class="command-display" style="display: none;">
            <h3>üíæ Save & Apply Your Changes</h3>
            <p class="command-explanation">This command saves your edits and immediately applies them to your Jekyll posts</p>
            <div class="command-box">
                <code id="save-and-apply-command-text"></code>
                <button onclick="copyCommand('save-and-apply-command-text')" class="copy-btn">Copy</button>
            </div>
            <ol class="command-steps">
                <li>Copy the command above</li>
                <li>Open Terminal</li>
                <li>Paste and press Enter</li>
                <li>Your changes will be saved and applied automatically</li>
                <li>Your site will refresh with the updates</li>
            </ol>
        </div>
        
        <div id="reprocess-command" class="command-display" style="display: none;">
            <h3>üîÑ Full Reprocess from Instagram Export</h3>
            <p class="command-explanation">‚ö†Ô∏è Only use this to completely rebuild all posts from your Instagram export (takes 2-3 minutes)</p>
            <div class="command-box">
                <code id="reprocess-command-text">cd /Users/joegaudet/joedev/worldcoffeetour && python3 process_export_enhanced.py</code>
                <button onclick="copyCommand('reprocess-command-text')" class="copy-btn">Copy</button>
            </div>
            <div class="warning-message">
                <strong>This will:</strong>
                <ul>
                    <li>Re-read your Instagram export data</li>
                    <li>Re-geocode all locations (API calls)</li>
                    <li>Regenerate all post files</li>
                    <li>Preserve your manual corrections</li>
                </ul>
            </div>
        </div>
        
    </div>
    
    <div id="posts-list" class="posts-list">
        <!-- Posts will be loaded here -->
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Post</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="edit-images" class="edit-images-gallery"></div>
                <form id="edit-form">
                    <input type="hidden" id="post-id" name="post-id">
                    
                    <div class="form-group">
                        <label for="cafe-name">Cafe Name:</label>
                        <input type="text" id="cafe-name" name="cafe_name" class="form-input">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City:</label>
                            <input type="text" id="city" name="city" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="country">Country:</label>
                            <input type="text" id="country" name="country" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="continent">Continent:</label>
                        <select id="continent" name="continent" class="form-input">
                            <option value="">Select continent...</option>
                            <option value="North America">North America</option>
                            <option value="South America">South America</option>
                            <option value="Europe">Europe</option>
                            <option value="Asia">Asia</option>
                            <option value="Africa">Africa</option>
                            <option value="Oceania">Oceania</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="latitude">Latitude:</label>
                            <input type="number" id="latitude" name="latitude" step="any" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="longitude">Longitude:</label>
                            <input type="number" id="longitude" name="longitude" step="any" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="place-search">Search for Location:</label>
                        <input type="text" id="place-search" placeholder="Type to search for cafes, addresses, or places..." class="form-input" autocomplete="off">
                        <div id="typeahead-results" class="typeahead-results" style="display: none;"></div>
                    </div>
                    
                    <div id="edit-map" class="edit-map"></div>
                    
                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" name="notes" rows="3" class="form-input"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="rating">Rating (1-5):</label>
                        <select id="rating" name="rating" class="form-input">
                            <option value="">No rating</option>
                            <option value="1">1 ‚òï</option>
                            <option value="2">2 ‚òï</option>
                            <option value="3">3 ‚òï</option>
                            <option value="4">4 ‚òï</option>
                            <option value="5">5 ‚òï</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Pass coffee posts data to JavaScript
const coffeePostsData = [
    {% for post in site.coffee_posts %}
    {
        title: "{{ post.title | escape }}",
        url: "{{ post.url | relative_url }}",
        city: "{{ post.city | escape }}",
        country: "{{ post.country | escape }}",
        continent: "{{ post.continent | escape }}",
        latitude: {{ post.latitude | default: 'null' }},
        longitude: {{ post.longitude | default: 'null' }},
        cafe_name: "{{ post.cafe_name | escape }}",
        notes: "{{ post.notes | escape }}",
        rating: {{ post.rating | default: 'null' }},
        image_url: "{{ post.image_url | escape }}",
        images: [
            {% for image in post.images %}
            "{{ image | escape }}"{% unless forloop.last %},{% endunless %}
            {% endfor %}
        ]
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
];
</script>

<script>
let allPosts = [];
let corrections = {};
let filteredPosts = [];

// Map variables
let editMap = null;
let editMarker = null;
let typeaheadTimeout = null;
let currentTypeaheadResults = [];

// Helper function to build search context from form fields
function buildSearchContext() {
    const city = document.getElementById('city').value.trim();
    const country = document.getElementById('country').value.trim();
    
    const contextParts = [];
    if (city) contextParts.push(city);
    if (country) contextParts.push(country);
    // Don't include continent in search as it's too broad
    
    return contextParts.join(', ');
}

// Load corrections from localStorage
function loadCorrections() {
    const saved = localStorage.getItem('coffee-post-corrections');
    corrections = saved ? JSON.parse(saved) : {};
}

// Save corrections to localStorage
function saveCorrections() {
    localStorage.setItem('coffee-post-corrections', JSON.stringify(corrections));
}

// Apply corrections to post data
function applyCorrections(post) {
    const postId = getPostId(post);
    if (corrections[postId]) {
        return { ...post, ...corrections[postId] };
    }
    return post;
}

// Get unique post ID
function getPostId(post) {
    // Handle both Jekyll post objects and our data objects
    if (post.url) {
        return post.url.replace(/^\//, '').replace(/\/$/, '');
    }
    // Fallback: construct URL from available data
    if (post.date && post.title) {
        const date = typeof post.date === 'string' ? post.date : new Date(post.date).toISOString().split('T')[0];
        const slug = post.title.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-').substring(0, 50);
        return `coffee/${date}-${slug}`;
    }
    return post.id || 'unknown';
}

// Initialize the interface
document.addEventListener('DOMContentLoaded', function() {
    // Ensure modal is closed on page load
    closeModal();
    
    loadCorrections();
    loadPosts();
    setupEventListeners();
    loadFilterSettings(); // This will also trigger filtering
});

function loadPosts() {
    // Use the coffeePostsData from the main page
    if (typeof coffeePostsData !== 'undefined') {
        console.log('Loading posts, raw data:', coffeePostsData.length);
        allPosts = coffeePostsData.map(applyCorrections);
        console.log('Posts after corrections:', allPosts.length);
        populateFilters();
        displayPosts(allPosts);
        updateStats();
    } else {
        console.error('coffeePostsData is not defined');
    }
}

function populateFilters() {
    const continents = [...new Set(allPosts.map(p => p.continent).filter(Boolean))].sort();
    const countries = [...new Set(allPosts.map(p => p.country).filter(Boolean))].sort();
    
    console.log('Continents found:', continents);
    console.log('Countries found:', countries);
    
    const continentSelect = document.getElementById('continent-filter');
    const countrySelect = document.getElementById('country-filter');
    
    if (!continentSelect || !countrySelect) {
        console.error('Filter elements not found');
        return;
    }
    
    // Clear existing options except the first one
    continentSelect.innerHTML = '<option value="">All Continents</option>';
    countrySelect.innerHTML = '<option value="">All Countries</option>';
    
    continents.forEach(continent => {
        const option = document.createElement('option');
        option.value = continent;
        option.textContent = continent;
        continentSelect.appendChild(option);
    });
    
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countrySelect.appendChild(option);
    });
}

function displayPosts(posts) {
    filteredPosts = posts;
    const container = document.getElementById('posts-list');
    container.innerHTML = '';
    
    posts.forEach(post => {
        const postEl = createPostElement(post);
        container.appendChild(postEl);
    });
}

function createPostElement(post) {
    const postId = getPostId(post);
    const hasCorrections = corrections[postId];
    const hasLocation = post.latitude && post.longitude;
    const hasCafe = post.cafe_name;
    
    const div = document.createElement('div');
    div.className = `post-item ${hasCorrections ? 'has-corrections' : ''} ${!hasLocation ? 'no-location' : ''} ${!hasCafe ? 'no-cafe' : ''}`;
    
    // Get post images from Jekyll data
    const postData = coffeePostsData.find(p => getPostId(p) === postId);
    const hasImage = postData && postData.image_url;
    
    div.innerHTML = `
        <div class="post-header">
            <h4>${post.title || 'Untitled'}</h4>
            <div class="post-badges">
                ${hasCorrections ? '<span class="badge edited">Edited</span>' : ''}
                ${!hasLocation ? '<span class="badge warning">No Location</span>' : ''}
                ${!hasCafe ? '<span class="badge warning">No Cafe</span>' : ''}
            </div>
        </div>
        ${hasImage ? `<div class="post-thumbnail"><img src="${postData.image_url}" alt="${post.title}" loading="lazy" onclick="showImageModal('${postData.image_url}', '${post.title}')"></div>` : ''}
        <div class="post-meta">
            <span><strong>Cafe:</strong> ${post.cafe_name || 'Unknown'}</span>
            <span><strong>Location:</strong> ${post.city || '?'}, ${post.country || '?'}</span>
            <span><strong>Coordinates:</strong> ${hasLocation ? `${post.latitude}, ${post.longitude}` : 'Missing'}</span>
        </div>
        <div class="post-actions">
            <button class="btn btn-small btn-primary" onclick="editPost('${postId}')">Edit</button>
            <a href="${post.url}" target="_blank" class="btn btn-small btn-secondary">View</a>
        </div>
    `;
    
    return div;
}

function editPost(postId) {
    const post = allPosts.find(p => getPostId(p) === postId);
    if (!post) return;
    
    // Get post data with images
    const postData = coffeePostsData.find(p => getPostId(p) === postId);
    
    // Populate form
    document.getElementById('post-id').value = postId;
    document.getElementById('cafe-name').value = post.cafe_name || '';
    document.getElementById('city').value = post.city || '';
    document.getElementById('country').value = post.country || '';
    document.getElementById('continent').value = post.continent || '';
    document.getElementById('latitude').value = post.latitude || '';
    document.getElementById('longitude').value = post.longitude || '';
    document.getElementById('notes').value = post.notes || '';
    document.getElementById('rating').value = post.rating || '';
    
    // Populate images
    populateEditImages(postData);
    
    document.getElementById('edit-modal').style.display = 'block';
    
    // Set up place search event listeners
    setupPlaceSearchListeners();
    
    // Initialize map after modal is shown
    setTimeout(() => {
        initEditMap(post.latitude, post.longitude);
    }, 100);
}

function populateEditImages(postData) {
    const imagesContainer = document.getElementById('edit-images');
    if (!imagesContainer || !postData) return;
    
    // Determine which images to show
    let imagesToShow = [];
    if (postData.images && postData.images.length > 0) {
        imagesToShow = postData.images;
    } else if (postData.image_url) {
        imagesToShow = [postData.image_url];
    }
    
    if (imagesToShow.length === 0) {
        imagesContainer.innerHTML = '<p class="no-images">No images available for this post</p>';
        return;
    }
    
    const imagesHTML = imagesToShow.map(imageUrl => {
        return `
            <div class="edit-image-item">
                <img src="${imageUrl}" alt="${postData.title}" loading="lazy" onclick="showImageModal('${imageUrl}', '${postData.title}')">
            </div>
        `;
    }).join('');
    
    imagesContainer.innerHTML = `
        <div class="edit-images-grid">
            ${imagesHTML}
        </div>
    `;
}

function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
    
    // Clear the form
    document.getElementById('edit-form').reset();
    document.getElementById('edit-images').innerHTML = '';
    
    if (editMap) {
        editMap.remove();
        editMap = null;
        editMarker = null;
    }
}

function initEditMap(lat, lng) {
    // Remove existing map
    if (editMap) {
        editMap.remove();
        editMap = null;
        editMarker = null;
    }
    
    const mapContainer = document.getElementById('edit-map');
    if (!mapContainer) return;
    
    // Set default location or use provided coordinates
    const defaultLat = lat || 40.7128;
    const defaultLng = lng || -74.0060;
    const zoom = (lat && lng) ? 15 : 2;
    
    // Initialize map
    editMap = L.map('edit-map').setView([defaultLat, defaultLng], zoom);
    
    // Add dark tiles to match site theme
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(editMap);
    
    // Add marker if coordinates exist
    if (lat && lng) {
        addEditMarker(lat, lng);
    }
    
    // Click handler to set location
    editMap.on('click', function(e) {
        const { lat, lng } = e.latlng;
        addEditMarker(lat, lng);
        updateCoordinateInputs(lat, lng);
        reverseGeocode(lat, lng);
    });
}

function addEditMarker(lat, lng) {
    if (editMarker) {
        editMap.removeLayer(editMarker);
    }
    
    const coffeeIcon = L.divIcon({
        html: '<div style="background: #d4a574; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0a0a0a; font-size: 16px; box-shadow: 0 2px 6px rgba(212, 165, 116, 0.4);">‚òï</div>',
        iconSize: [30, 30],
        className: 'coffee-marker'
    });
    
    editMarker = L.marker([lat, lng], { icon: coffeeIcon }).addTo(editMap);
}

function updateCoordinateInputs(lat, lng) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
}

async function reverseGeocode(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
        const data = await response.json();
        
        if (data && data.address) {
            const addr = data.address;
            
            // Auto-fill city
            const city = addr.city || addr.town || addr.village || addr.suburb;
            if (city && !document.getElementById('city').value) {
                document.getElementById('city').value = city;
            }
            
            // Auto-fill country
            if (addr.country && !document.getElementById('country').value) {
                document.getElementById('country').value = addr.country;
            }
            
            // Auto-detect continent
            if (addr.country_code && !document.getElementById('continent').value) {
                const continent = getContinent(addr.country_code);
                if (continent) {
                    document.getElementById('continent').value = continent;
                }
            }
        }
    } catch (error) {
        console.error('Reverse geocoding failed:', error);
    }
}

function getContinent(countryCode) {
    const continents = {
        // North America
        'us': 'North America', 'ca': 'North America', 'mx': 'North America',
        // South America  
        'ar': 'South America', 'cl': 'South America', 'br': 'South America', 'pe': 'South America',
        // Europe
        'gb': 'Europe', 'fr': 'Europe', 'de': 'Europe', 'it': 'Europe', 'es': 'Europe', 'nl': 'Europe',
        // Asia
        'jp': 'Asia', 'cn': 'Asia', 'kr': 'Asia', 'th': 'Asia', 'in': 'Asia',
        // Africa
        'za': 'Africa', 'eg': 'Africa', 'ma': 'Africa',
        // Oceania
        'au': 'Oceania', 'nz': 'Oceania'
    };
    return continents[countryCode.toLowerCase()];
}

function typeaheadSearch(query) {
    // Clear existing timeout
    if (typeaheadTimeout) {
        clearTimeout(typeaheadTimeout);
    }
    
    // Hide typeahead if query is too short
    if (query.length < 3) {
        hideTypeahead();
        return;
    }
    
    // Debounce search - wait for 500ms pause in typing
    typeaheadTimeout = setTimeout(() => {
        performTypeaheadSearch(query);
    }, 500);
}

async function performTypeaheadSearch(query) {
    try {
        // Build context from existing form fields
        const context = buildSearchContext();
        console.log('Searching for:', query, 'with context:', context);
        
        // Create prioritized search queries
        const searchPromises = [];
        
        // Most specific: if we have context, search with it first
        if (context) {
            // Search for the query in the specific location
            searchPromises.push(
                fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ', ' + context)}&format=json&addressdetails=1&limit=4`)
                    .then(r => r.json())
                    .catch(() => [])
            );
            
            // Also search for cafes specifically in that location
            searchPromises.push(
                fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ' cafe, ' + context)}&format=json&addressdetails=1&limit=2`)
                    .then(r => r.json())
                    .catch(() => [])
            );
        } else {
            // No context, just search broadly
            searchPromises.push(
                fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=4`)
                    .then(r => r.json())
                    .catch(() => [])
            );
            
            searchPromises.push(
                fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ' cafe')}&format=json&addressdetails=1&limit=2`)
                    .then(r => r.json())
                    .catch(() => [])
            );
        }
        
        const results = await Promise.all(searchPromises);
        const allResults = results.flat();
        
        // Deduplicate by place_id and keep order (prioritized results first)
        const uniqueResults = [];
        const seenIds = new Set();
        
        for (const result of allResults) {
            if (!seenIds.has(result.place_id)) {
                seenIds.add(result.place_id);
                uniqueResults.push(result);
                if (uniqueResults.length >= 8) break;
            }
        }
        
        console.log('Found', uniqueResults.length, 'unique results');
        
        if (uniqueResults.length > 0) {
            currentTypeaheadResults = uniqueResults;
            showTypeaheadResults(uniqueResults);
        } else {
            hideTypeahead();
        }
    } catch (error) {
        console.error('Typeahead search failed:', error);
        hideTypeahead();
    }
}

function showTypeaheadResults(results) {
    const typeaheadDiv = document.getElementById('typeahead-results');
    if (!typeaheadDiv) return;
    
    const resultsHTML = results.map((result, index) => {
        const name = result.display_name.split(',')[0];
        const address = result.display_name.split(',').slice(1, 3).join(',').trim();
        const type = result.type || result.class || '';
        const isCafe = type === 'cafe' || result.class === 'amenity';
        
        return `
            <div class="typeahead-result ${isCafe ? 'cafe-result' : ''}" onclick="selectTypeaheadResult(${index})">
                <div class="typeahead-name">
                    ${isCafe ? '‚òï ' : 'üìç '}${name}
                </div>
                <div class="typeahead-address">${address}</div>
            </div>
        `;
    }).join('');
    
    typeaheadDiv.innerHTML = resultsHTML;
    typeaheadDiv.style.display = 'block';
}

function hideTypeahead() {
    const typeaheadDiv = document.getElementById('typeahead-results');
    if (typeaheadDiv) {
        typeaheadDiv.style.display = 'none';
    }
    currentTypeaheadResults = [];
}

function navigateTypeahead(direction) {
    const results = document.querySelectorAll('.typeahead-result');
    if (results.length === 0) return;
    
    const current = document.querySelector('.typeahead-result.selected');
    let nextIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(results).indexOf(current);
        if (direction === 'down') {
            nextIndex = (currentIndex + 1) % results.length;
        } else {
            nextIndex = currentIndex === 0 ? results.length - 1 : currentIndex - 1;
        }
        current.classList.remove('selected');
    }
    
    results[nextIndex].classList.add('selected');
}

function selectTypeaheadResult(index) {
    if (!currentTypeaheadResults[index]) return;
    
    const result = currentTypeaheadResults[index];
    const lat = parseFloat(result.lat);
    const lng = parseFloat(result.lon);
    
    console.log('Selected location:', result.display_name, 'Coordinates:', lat, lng);
    
    // Set the search input to the selected result
    document.getElementById('place-search').value = result.display_name.split(',')[0];
    
    // Update coordinate inputs first (always do this)
    updateCoordinateInputs(lat, lng);
    
    // Update map if it exists
    if (editMap) {
        addEditMarker(lat, lng);
        editMap.setView([lat, lng], 15);
    } else {
        console.log('Map not initialized yet, will set coordinates when map loads');
        // Store coordinates for when map initializes
        setTimeout(() => {
            if (editMap) {
                addEditMarker(lat, lng);
                editMap.setView([lat, lng], 15);
            }
        }, 500);
    }
    
    // Auto-fill form fields
    if (result.address) {
        const addr = result.address;
        
        // Extract cafe name if it's a cafe/restaurant
        if (result.type === 'cafe' || result.class === 'amenity' || result.name) {
            const name = result.name || result.display_name.split(',')[0];
            const cafeNameField = document.getElementById('cafe-name');
            if (cafeNameField && !cafeNameField.value) {
                cafeNameField.value = name;
            }
        }
        
        // Fill location fields
        const city = addr.city || addr.town || addr.village || addr.suburb || addr.municipality;
        if (city) {
            const cityField = document.getElementById('city');
            if (cityField) cityField.value = city;
        }
        
        if (addr.country) {
            const countryField = document.getElementById('country');
            if (countryField) countryField.value = addr.country;
        }
        
        if (addr.country_code) {
            const continent = getContinent(addr.country_code);
            if (continent) {
                const continentField = document.getElementById('continent');
                if (continentField) continentField.value = continent;
            }
        }
    }
    
    // Hide typeahead
    hideTypeahead();
    
    console.log('Updated coordinates to:', document.getElementById('latitude').value, document.getElementById('longitude').value);
}

// Removed searchPlaces and showSearchResults functions - using typeahead only

function setupPlaceSearchListeners() {
    const placeSearchInput = document.getElementById('place-search');
    if (!placeSearchInput) {
        console.error('Place search input not found');
        return;
    }
    
    // Remove any existing listeners first
    const newInput = placeSearchInput.cloneNode(true);
    placeSearchInput.parentNode.replaceChild(newInput, placeSearchInput);
    
    // Add fresh event listeners
    newInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        console.log('Input event triggered, query:', query);
        typeaheadSearch(query);
    });
    
    newInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideTypeahead();
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateTypeahead('down');
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateTypeahead('up');
        } else if (e.key === 'Enter') {
            e.preventDefault();
            const selected = document.querySelector('.typeahead-result.selected');
            if (selected) {
                const index = Array.from(selected.parentNode.children).indexOf(selected);
                selectTypeaheadResult(index);
            }
        }
    });
    
    newInput.addEventListener('blur', function() {
        // Delay hiding to allow click on results
        setTimeout(hideTypeahead, 200);
    });
    
    newInput.addEventListener('focus', function() {
        const query = this.value.trim();
        if (query.length >= 3) {
            typeaheadSearch(query);
        }
    });
}

function showImageModal(imageUrl, title) {
    // Create modal if it doesn't exist
    let imageModal = document.getElementById('image-modal');
    if (!imageModal) {
        imageModal = document.createElement('div');
        imageModal.id = 'image-modal';
        imageModal.className = 'modal';
        imageModal.innerHTML = `
            <div class="modal-content image-modal-content">
                <div class="modal-header">
                    <h3 id="image-modal-title"></h3>
                    <button class="close-btn" onclick="closeImageModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <img id="image-modal-img" src="" alt="" style="max-width: 100%; height: auto;">
                </div>
            </div>
        `;
        document.body.appendChild(imageModal);
        
        // Close on background click
        imageModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
    }
    
    // Set content and show
    document.getElementById('image-modal-title').textContent = title;
    document.getElementById('image-modal-img').src = imageUrl;
    imageModal.style.display = 'block';
}

function closeImageModal() {
    const imageModal = document.getElementById('image-modal');
    if (imageModal) {
        imageModal.style.display = 'none';
    }
}

function setupEventListeners() {
    // Search
    const searchInput = document.getElementById('search-input');
    const continentFilter = document.getElementById('continent-filter');
    const countryFilter = document.getElementById('country-filter');
    const showProblematic = document.getElementById('show-problematic');
    const saveApplyBtn = document.getElementById('save-and-apply-btn');
    
    if (searchInput) searchInput.addEventListener('input', filterPosts);
    if (continentFilter) continentFilter.addEventListener('change', filterPosts);
    if (countryFilter) countryFilter.addEventListener('change', filterPosts);
    if (showProblematic) showProblematic.addEventListener('change', filterPosts);
    
    // Tools buttons
    if (saveApplyBtn) {
        saveApplyBtn.addEventListener('click', function() {
        const corrections = localStorage.getItem('coffee-post-corrections');
        if (!corrections || corrections === '{}') {
            alert('No corrections found. Make some edits first!');
            return;
        }
        
        const saveCommand = `cd /Users/joegaudet/joedev/worldcoffeetour && python3 update_corrections.py '${corrections}'`;
        const combinedCommand = saveCommand + ' && python3 apply_corrections.py';
        document.getElementById('save-and-apply-command-text').textContent = combinedCommand;
        
        // Hide other commands, show this one
        document.querySelectorAll('.command-display').forEach(el => el.style.display = 'none');
        document.getElementById('save-and-apply-command').style.display = 'block';
        });
    }
    
    const fullReprocessBtn = document.getElementById('full-reprocess-btn');
    if (fullReprocessBtn) {
        fullReprocessBtn.addEventListener('click', function() {
            // Hide other commands, show this one
            document.querySelectorAll('.command-display').forEach(el => el.style.display = 'none');
            document.getElementById('reprocess-command').style.display = 'block';
        });
    }
    
    
    // Places search with typeahead - only set up when modal is shown
    // We'll set these up dynamically when the edit modal opens
    
    // Form submission
    document.getElementById('edit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        savePost();
    });
    
    // Close modal on background click
    document.getElementById('edit-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

function filterPosts() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const continent = document.getElementById('continent-filter').value;
    const country = document.getElementById('country-filter').value;
    const showProblematicOnly = document.getElementById('show-problematic').checked;
    
    // Save filter settings to localStorage
    saveFilterSettings();
    
    console.log('Filtering posts with:', { search, continent, country, showProblematicOnly });
    console.log('Total posts before filtering:', allPosts.length);
    
    let filtered = allPosts;
    
    if (search) {
        filtered = filtered.filter(post => 
            (post.title || '').toLowerCase().includes(search) ||
            (post.cafe_name || '').toLowerCase().includes(search) ||
            (post.city || '').toLowerCase().includes(search) ||
            (post.country || '').toLowerCase().includes(search)
        );
        console.log('After search filter:', filtered.length);
    }
    
    if (continent) {
        filtered = filtered.filter(post => post.continent === continent);
        console.log('After continent filter:', filtered.length);
    }
    
    if (country) {
        filtered = filtered.filter(post => post.country === country);
        console.log('After country filter:', filtered.length);
    }
    
    if (showProblematicOnly) {
        filtered = filtered.filter(post => {
            const postId = getPostId(post);
            const hasCorrections = corrections[postId];
            const effectivePost = hasCorrections ? {...post, ...hasCorrections} : post;
            const isProblematic = !effectivePost.latitude || !effectivePost.longitude || !effectivePost.cafe_name;
            
            // Debug logging
            if (hasCorrections) {
                console.log(`Post ${postId}:`, {
                    original: { lat: post.latitude, lng: post.longitude, cafe: post.cafe_name },
                    corrections: hasCorrections,
                    effective: { lat: effectivePost.latitude, lng: effectivePost.longitude, cafe: effectivePost.cafe_name },
                    isProblematic
                });
            }
            
            return isProblematic;
        });
        console.log('After problematic filter:', filtered.length);
    }
    
    console.log('Final filtered count:', filtered.length);
    displayPosts(filtered);
    updateStats();
}


function savePost() {
    const form = document.getElementById('edit-form');
    const formData = new FormData(form);
    const postId = formData.get('post-id');
    
    // Create correction object
    const correction = {};
    for (const [key, value] of formData.entries()) {
        if (key !== 'post-id' && value) {
            if (key === 'latitude' || key === 'longitude') {
                correction[key] = parseFloat(value);
            } else {
                correction[key] = value;
            }
        }
    }
    
    // Save correction
    corrections[postId] = correction;
    saveCorrections();
    
    // Update display
    allPosts = coffeePostsData.map(applyCorrections);
    filterPosts();
    closeModal();
    
    alert('Changes saved!');
}

function saveFilterSettings() {
    const filterSettings = {
        search: document.getElementById('search-input').value,
        continent: document.getElementById('continent-filter').value,
        country: document.getElementById('country-filter').value,
        showProblematic: document.getElementById('show-problematic').checked
    };
    localStorage.setItem('admin-filter-settings', JSON.stringify(filterSettings));
}

function loadFilterSettings() {
    const saved = localStorage.getItem('admin-filter-settings');
    if (saved) {
        try {
            const settings = JSON.parse(saved);
            
            // Wait for filters to be populated first
            setTimeout(() => {
                document.getElementById('search-input').value = settings.search || '';
                document.getElementById('continent-filter').value = settings.continent || '';
                document.getElementById('country-filter').value = settings.country || '';
                document.getElementById('show-problematic').checked = settings.showProblematic || false;
                
                // Apply the filters after loading settings
                filterPosts();
            }, 200);
        } catch (e) {
            console.error('Failed to load filter settings:', e);
        }
    }
}

function updateStats() {
    const total = filteredPosts.length;
    const noLocation = filteredPosts.filter(p => !p.latitude || !p.longitude).length;
    const noCafe = filteredPosts.filter(p => !p.cafe_name).length;
    
    document.getElementById('total-posts').textContent = total;
    document.getElementById('no-location').textContent = noLocation;
    document.getElementById('no-cafe').textContent = noCafe;
}

// Export corrections function
function exportCorrections() {
    if (Object.keys(corrections).length === 0) {
        alert('No corrections to export! Make some edits first.');
        return;
    }
    
    const dataStr = JSON.stringify(corrections, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'corrections-export.json';
    link.click();
    
    // Show instructions
    setTimeout(() => {
        const instructions = `
Corrections exported! To apply them:

1. The file has been downloaded as 'corrections-export.json'
2. Copy the contents and merge them into 'post-corrections.json' in your project root
3. Re-run the processing script: python3 process_export_enhanced.py
4. Your corrections will be preserved and won't be overwritten

Alternatively, use the export_corrections.py script:
python3 export_corrections.py '${dataStr}'
        `;
        alert(instructions);
    }, 100);
}

// Copy command to clipboard function
function copyCommand(elementId) {
    const commandElement = document.getElementById(elementId);
    const commandText = commandElement.textContent;
    
    // Store reference to button for feedback
    const btn = event.target;
    
    // Try modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(commandText).then(() => {
            showCopySuccess(btn);
        }).catch(err => {
            console.error('Clipboard API failed:', err);
            fallbackCopy(commandElement, btn);
        });
    } else {
        // Fallback for older browsers or non-HTTPS
        fallbackCopy(commandElement, btn);
    }
}

function fallbackCopy(element, btn) {
    try {
        // Create a temporary textarea with the text
        const textarea = document.createElement('textarea');
        textarea.value = element.textContent;
        textarea.style.position = 'fixed';
        textarea.style.left = '-999999px';
        textarea.style.top = '-999999px';
        document.body.appendChild(textarea);
        
        // Select and copy
        textarea.focus();
        textarea.select();
        const successful = document.execCommand('copy');
        
        // Remove temporary element
        document.body.removeChild(textarea);
        
        if (successful) {
            showCopySuccess(btn);
        } else {
            showCopyFallback(btn);
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showCopyFallback(btn);
    }
}

function showCopySuccess(btn) {
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    btn.style.background = '#4ade80';
    setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
    }, 2000);
}

function showCopyFallback(btn) {
    const originalText = btn.textContent;
    btn.textContent = 'Copy Failed';
    btn.style.background = '#f87171';
    setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
    }, 3000);
    alert('Copy failed. Please manually select and copy the command above.');
}
</script>

<style>
.admin-interface {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.search-filters {
    display: flex;
    gap: 1rem;
    margin: 2rem 0;
    flex-wrap: wrap;
}

.search-input, .filter-select {
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--card-bg);
    color: var(--primary-color);
    font-family: inherit;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--primary-color);
}

.checkbox-input {
    cursor: pointer;
}

.search-input {
    flex: 1;
    min-width: 200px;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--accent-color);
    color: var(--bg-color);
}

.btn-secondary {
    background: var(--border-color);
    color: var(--primary-color);
}

.btn-warning {
    background: #ff9500;
    color: white;
}

.btn-small {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
}

.btn:hover {
    opacity: 0.8;
}

.stats {
    margin: 1rem 0;
    padding: 1rem;
    background: var(--card-bg);
    border-radius: 4px;
    color: var(--text-light);
}

.tools-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.tools-section h2 {
    color: var(--accent-color);
    margin: 0 0 0.5rem 0;
    font-size: 1.3rem;
}

.tools-description {
    color: var(--text-light);
    margin: 0 0 1.5rem 0;
}

.workflow-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.workflow-buttons .btn {
    flex: 1;
    min-width: 160px;
}

.command-display {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(212, 165, 116, 0.1);
    border: 1px solid var(--accent-color);
    border-radius: 4px;
}

.command-display h3 {
    color: var(--accent-color);
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

.command-box {
    display: flex;
    gap: 1rem;
    margin: 0.5rem 0;
    align-items: center;
}

.command-box code {
    flex: 1;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    padding: 0.75rem;
    border-radius: 4px;
    font-family: 'Courier Prime', monospace;
    color: var(--accent-color);
    word-break: break-all;
    font-size: 0.9rem;
}

.command-box .copy-btn {
    background: var(--accent-color);
    color: var(--bg-color);
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.command-display .instructions {
    color: var(--text-light);
    margin: 0.5rem 0 0 0;
    font-size: 0.9rem;
    font-style: italic;
}

.command-explanation {
    color: var(--text-light);
    margin: 0 0 1rem 0;
    font-size: 0.95rem;
}

.command-steps {
    margin: 1rem 0 0 0;
    padding-left: 1.5rem;
    color: var(--text-light);
    font-size: 0.9rem;
    line-height: 1.6;
}

.command-steps li {
    margin-bottom: 0.5rem;
}

.warning-message {
    background: rgba(255, 149, 0, 0.1);
    border: 1px solid rgba(255, 149, 0, 0.3);
    border-radius: 4px;
    padding: 1rem;
    margin-top: 1rem;
    color: #fbbf24;
    font-size: 0.9rem;
}

.warning-message ul {
    margin: 0.5rem 0 0 1rem;
    padding-left: 1rem;
}

.posts-list {
    display: grid;
    gap: 1rem;
}

.post-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    transition: border-color 0.3s ease;
}

.post-item.has-corrections {
    border-left: 4px solid var(--accent-color);
}

.post-item.no-location {
    border-left: 4px solid #ff9500;
}

.post-item.no-cafe {
    border-right: 4px solid #ff6b6b;
}

.post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.post-header h4 {
    margin: 0;
    color: var(--primary-color);
}

.post-badges {
    display: flex;
    gap: 0.5rem;
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge.edited {
    background: var(--accent-color);
    color: var(--bg-color);
}

.badge.warning {
    background: #ff9500;
    color: white;
}

.post-meta {
    display: grid;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: var(--text-light);
    font-size: 0.9rem;
}

.post-actions {
    display: flex;
    gap: 0.5rem;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    margin: 0;
    color: var(--primary-color);
}

.close-btn {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--primary-color);
    font-weight: 500;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-color);
    color: var(--primary-color);
    font-family: inherit;
}

.form-input:focus {
    outline: none;
    border-color: var(--accent-color);
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
}

@media (max-width: 768px) {
    .search-filters {
        flex-direction: column;
    }
    
    .post-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .modal-actions {
        flex-direction: column;
    }
}

/* Post thumbnails */
.post-thumbnail {
    margin: 1rem 0;
    text-align: center;
}

.post-thumbnail img {
    max-width: 200px;
    height: 120px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.post-thumbnail img:hover {
    transform: scale(1.05);
}

/* Edit map */
.edit-map {
    height: 300px;
    width: 100%;
    margin: 1rem 0;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

/* Typeahead results */
.typeahead-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.typeahead-result {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.typeahead-result:hover,
.typeahead-result.selected {
    background: rgba(212, 165, 116, 0.15);
}

.typeahead-result.cafe-result {
    border-left: 3px solid var(--accent-color);
}

.typeahead-result:last-child {
    border-bottom: none;
}

.typeahead-name {
    font-weight: 500;
    color: var(--primary-color);
    font-size: 0.95rem;
}

.typeahead-address {
    color: var(--text-light);
    font-size: 0.85rem;
    opacity: 0.8;
}

/* Search results */
.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.search-result {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
}

.search-result:hover {
    background: rgba(212, 165, 116, 0.1);
}

.search-result:last-child {
    border-bottom: none;
}

/* Image modal */
.image-modal-content {
    max-width: 90vw;
    max-height: 90vh;
}

.image-modal-content .modal-body {
    text-align: center;
    padding: 1rem;
}

/* Form group positioning for search results */
.form-group {
    position: relative;
}

/* Edit images gallery */
.edit-images-gallery {
    margin-bottom: 2rem;
}

.edit-images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.edit-image-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 2px solid var(--border-color);
}

.edit-image-item img:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
    border-color: var(--accent-color);
}

.no-images {
    text-align: center;
    color: var(--text-light);
    font-style: italic;
    margin: 1rem 0;
    padding: 2rem;
    border: 2px dashed var(--border-color);
    border-radius: 4px;
}

@media (max-width: 768px) {
    .edit-map {
        height: 250px;
    }
    
    .post-thumbnail img {
        max-width: 150px;
        height: 90px;
    }
    
    .edit-images-grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }
    
    .edit-image-item img {
        height: 80px;
    }
}
</style>