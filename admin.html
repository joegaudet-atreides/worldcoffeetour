---
layout: default
title: Admin - Edit Posts
---

<script>
// Pass coffee posts data to JavaScript
const coffeePostsData = [
    {% for post in site.coffee_posts %}
    {
        title: "{{ post.title | escape }}",
        url: "{{ post.url }}",
        date: "{{ post.date | date: '%Y-%m-%d' }}",
        city: "{{ post.city | default: '' }}",
        country: "{{ post.country | default: '' }}",
        continent: "{{ post.continent | default: '' }}",
        latitude: {{ post.latitude | default: 'null' }},
        longitude: {{ post.longitude | default: 'null' }},
        cafe_name: "{{ post.cafe_name | default: '' }}",
        rating: {{ post.rating | default: 'null' }},
        notes: `{{ post.notes | escape }}`,
        image_url: "{{ post.image_url | default: '' }}",
        {% if post.images %}images: [{% for image in post.images %}"{{ image }}"{% unless forloop.last %},{% endunless %}{% endfor %}],{% else %}images: [],{% endif %}
        instagram_url: "{{ post.instagram_url | default: '' }}"
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
];
</script>

<div class="admin-interface">
    <h1>Coffee Posts Admin</h1>
    <p>Edit post metadata - changes are saved to a corrections file and won't be overwritten by the script.</p>
    
    <div class="search-filters">
        <input type="text" id="search-input" placeholder="Search posts..." class="search-input">
        <select id="continent-filter" class="filter-select">
            <option value="">All Continents</option>
        </select>
        <select id="country-filter" class="filter-select">
            <option value="">All Countries</option>
        </select>
        <button id="show-problematic" class="btn btn-warning">Show Problematic Only</button>
        <button onclick="exportCorrections()" class="btn btn-primary">Export Corrections</button>
    </div>
    
    <div class="stats">
        <span id="total-posts">0</span> total posts | 
        <span id="no-location">0</span> missing location | 
        <span id="no-cafe">0</span> missing cafe name
    </div>
    
    <!-- Tools Section -->
    <div class="tools-section">
        <h2>Correction Tools</h2>
        <div class="tool-buttons">
            <button id="export-for-update-btn" class="btn btn-primary">Export for Update Script</button>
            <button id="apply-corrections-btn" class="btn btn-secondary">Show Apply Command</button>
            <button id="full-reprocess-btn" class="btn btn-warning">Show Reprocess Command</button>
        </div>
        
        <div id="export-command" class="command-display" style="display: none;">
            <h3>Step 1: Update corrections file</h3>
            <div class="command-box">
                <code id="update-command-text"></code>
                <button onclick="copyCommand('update-command-text')" class="copy-btn">Copy</button>
            </div>
            <p class="instructions">Run this command to save your edits to post-corrections.json</p>
        </div>
        
        <div id="apply-command" class="command-display" style="display: none;">
            <h3>Step 2: Apply corrections to posts</h3>
            <div class="command-box">
                <code id="apply-command-text">cd /Users/joegaudet/joedev/worldcoffeetour && python3 apply_corrections.py</code>
                <button onclick="copyCommand('apply-command-text')" class="copy-btn">Copy</button>
            </div>
            <p class="instructions">Run this after updating corrections to apply them to your posts</p>
        </div>
        
        <div id="reprocess-command" class="command-display" style="display: none;">
            <h3>Full Reprocess (2-3 minutes)</h3>
            <div class="command-box">
                <code id="reprocess-command-text">cd /Users/joegaudet/joedev/worldcoffeetour && python3 process_export_enhanced.py</code>
                <button onclick="copyCommand('reprocess-command-text')" class="copy-btn">Copy</button>
            </div>
            <p class="instructions">⚠️ This reprocesses all Instagram data and makes API calls</p>
        </div>
    </div>
    
    <div id="posts-list" class="posts-list">
        <!-- Posts will be loaded here -->
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Post</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="edit-images" class="edit-images-gallery"></div>
                <form id="edit-form">
                    <input type="hidden" id="post-id" name="post-id">
                    
                    <div class="form-group">
                        <label for="post-title">Title:</label>
                        <input type="text" id="post-title" name="title" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="cafe-name">Cafe Name:</label>
                        <input type="text" id="cafe-name" name="cafe_name" class="form-input">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City:</label>
                            <input type="text" id="city" name="city" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="country">Country:</label>
                            <input type="text" id="country" name="country" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="continent">Continent:</label>
                        <select id="continent" name="continent" class="form-input">
                            <option value="">Select continent...</option>
                            <option value="North America">North America</option>
                            <option value="South America">South America</option>
                            <option value="Europe">Europe</option>
                            <option value="Asia">Asia</option>
                            <option value="Africa">Africa</option>
                            <option value="Oceania">Oceania</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="latitude">Latitude:</label>
                            <input type="number" id="latitude" name="latitude" step="any" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="longitude">Longitude:</label>
                            <input type="number" id="longitude" name="longitude" step="any" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="place-search">Search for Location:</label>
                        <input type="text" id="place-search" placeholder="Search for cafes, addresses, or places..." class="form-input" autocomplete="off">
                        <button type="button" id="search-places-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">Search</button>
                        <div id="typeahead-results" class="typeahead-results" style="display: none;"></div>
                    </div>
                    
                    <div id="edit-map" class="edit-map"></div>
                    
                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" name="notes" rows="3" class="form-input"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="rating">Rating (1-5):</label>
                        <select id="rating" name="rating" class="form-input">
                            <option value="">No rating</option>
                            <option value="1">1 ☕</option>
                            <option value="2">2 ☕</option>
                            <option value="3">3 ☕</option>
                            <option value="4">4 ☕</option>
                            <option value="5">5 ☕</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Pass coffee posts data to JavaScript
const coffeePostsData = [
    {% for post in site.coffee_posts %}
    {
        title: "{{ post.title | escape }}",
        url: "{{ post.url | relative_url }}",
        city: "{{ post.city | escape }}",
        country: "{{ post.country | escape }}",
        continent: "{{ post.continent | escape }}",
        latitude: {{ post.latitude | default: 'null' }},
        longitude: {{ post.longitude | default: 'null' }},
        cafe_name: "{{ post.cafe_name | escape }}",
        notes: "{{ post.notes | escape }}",
        rating: {{ post.rating | default: 'null' }},
        image_url: "{{ post.image_url | escape }}",
        images: [
            {% for image in post.images %}
            "{{ image | escape }}"{% unless forloop.last %},{% endunless %}
            {% endfor %}
        ]
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
];
</script>

<script>
let allPosts = [];
let corrections = {};
let filteredPosts = [];

// Map variables
let editMap = null;
let editMarker = null;
let searchResults = [];
let typeaheadTimeout = null;
let currentTypeaheadResults = [];

// Load corrections from localStorage
function loadCorrections() {
    const saved = localStorage.getItem('coffee-post-corrections');
    corrections = saved ? JSON.parse(saved) : {};
}

// Save corrections to localStorage
function saveCorrections() {
    localStorage.setItem('coffee-post-corrections', JSON.stringify(corrections));
}

// Apply corrections to post data
function applyCorrections(post) {
    const postId = getPostId(post);
    if (corrections[postId]) {
        return { ...post, ...corrections[postId] };
    }
    return post;
}

// Get unique post ID
function getPostId(post) {
    // Handle both Jekyll post objects and our data objects
    if (post.url) {
        return post.url.replace(/^\//, '').replace(/\/$/, '');
    }
    // Fallback: construct URL from available data
    if (post.date && post.title) {
        const date = typeof post.date === 'string' ? post.date : new Date(post.date).toISOString().split('T')[0];
        const slug = post.title.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-').substring(0, 50);
        return `coffee/${date}-${slug}`;
    }
    return post.id || 'unknown';
}

// Initialize the interface
document.addEventListener('DOMContentLoaded', function() {
    loadCorrections();
    loadPosts();
    setupEventListeners();
});

function loadPosts() {
    // Use the coffeePostsData from the main page
    if (typeof coffeePostsData !== 'undefined') {
        console.log('Loading posts, raw data:', coffeePostsData.length);
        allPosts = coffeePostsData.map(applyCorrections);
        console.log('Posts after corrections:', allPosts.length);
        populateFilters();
        displayPosts(allPosts);
        updateStats();
    } else {
        console.error('coffeePostsData is not defined');
    }
}

function populateFilters() {
    const continents = [...new Set(allPosts.map(p => p.continent).filter(Boolean))].sort();
    const countries = [...new Set(allPosts.map(p => p.country).filter(Boolean))].sort();
    
    console.log('Continents found:', continents);
    console.log('Countries found:', countries);
    
    const continentSelect = document.getElementById('continent-filter');
    const countrySelect = document.getElementById('country-filter');
    
    if (!continentSelect || !countrySelect) {
        console.error('Filter elements not found');
        return;
    }
    
    // Clear existing options except the first one
    continentSelect.innerHTML = '<option value="">All Continents</option>';
    countrySelect.innerHTML = '<option value="">All Countries</option>';
    
    continents.forEach(continent => {
        const option = document.createElement('option');
        option.value = continent;
        option.textContent = continent;
        continentSelect.appendChild(option);
    });
    
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countrySelect.appendChild(option);
    });
}

function displayPosts(posts) {
    filteredPosts = posts;
    const container = document.getElementById('posts-list');
    container.innerHTML = '';
    
    posts.forEach(post => {
        const postEl = createPostElement(post);
        container.appendChild(postEl);
    });
}

function createPostElement(post) {
    const postId = getPostId(post);
    const hasCorrections = corrections[postId];
    const hasLocation = post.latitude && post.longitude;
    const hasCafe = post.cafe_name;
    
    const div = document.createElement('div');
    div.className = `post-item ${hasCorrections ? 'has-corrections' : ''} ${!hasLocation ? 'no-location' : ''} ${!hasCafe ? 'no-cafe' : ''}`;
    
    // Get post images from Jekyll data
    const postData = coffeePostsData.find(p => getPostId(p) === postId);
    const hasImage = postData && postData.image_url;
    
    div.innerHTML = `
        <div class="post-header">
            <h4>${post.title || 'Untitled'}</h4>
            <div class="post-badges">
                ${hasCorrections ? '<span class="badge edited">Edited</span>' : ''}
                ${!hasLocation ? '<span class="badge warning">No Location</span>' : ''}
                ${!hasCafe ? '<span class="badge warning">No Cafe</span>' : ''}
            </div>
        </div>
        ${hasImage ? `<div class="post-thumbnail"><img src="${postData.image_url}" alt="${post.title}" loading="lazy" onclick="showImageModal('${postData.image_url}', '${post.title}')"></div>` : ''}
        <div class="post-meta">
            <span><strong>Cafe:</strong> ${post.cafe_name || 'Unknown'}</span>
            <span><strong>Location:</strong> ${post.city || '?'}, ${post.country || '?'}</span>
            <span><strong>Coordinates:</strong> ${hasLocation ? `${post.latitude}, ${post.longitude}` : 'Missing'}</span>
        </div>
        <div class="post-actions">
            <button class="btn btn-small btn-primary" onclick="editPost('${postId}')">Edit</button>
            <a href="${post.url}" target="_blank" class="btn btn-small btn-secondary">View</a>
        </div>
    `;
    
    return div;
}

function editPost(postId) {
    const post = allPosts.find(p => getPostId(p) === postId);
    if (!post) return;
    
    // Get post data with images
    const postData = coffeePostsData.find(p => getPostId(p) === postId);
    
    // Populate form
    document.getElementById('post-id').value = postId;
    document.getElementById('post-title').value = post.title || '';
    document.getElementById('cafe-name').value = post.cafe_name || '';
    document.getElementById('city').value = post.city || '';
    document.getElementById('country').value = post.country || '';
    document.getElementById('continent').value = post.continent || '';
    document.getElementById('latitude').value = post.latitude || '';
    document.getElementById('longitude').value = post.longitude || '';
    document.getElementById('notes').value = post.notes || '';
    document.getElementById('rating').value = post.rating || '';
    
    // Populate images
    populateEditImages(postData);
    
    document.getElementById('edit-modal').style.display = 'block';
    
    // Initialize map after modal is shown
    setTimeout(() => {
        initEditMap(post.latitude, post.longitude);
    }, 100);
}

function populateEditImages(postData) {
    const imagesContainer = document.getElementById('edit-images');
    if (!imagesContainer || !postData) return;
    
    // Determine which images to show
    let imagesToShow = [];
    if (postData.images && postData.images.length > 0) {
        imagesToShow = postData.images;
    } else if (postData.image_url) {
        imagesToShow = [postData.image_url];
    }
    
    if (imagesToShow.length === 0) {
        imagesContainer.innerHTML = '<p class="no-images">No images available for this post</p>';
        return;
    }
    
    const imagesHTML = imagesToShow.map(imageUrl => {
        return `
            <div class="edit-image-item">
                <img src="${imageUrl}" alt="${postData.title}" loading="lazy" onclick="showImageModal('${imageUrl}', '${postData.title}')">
            </div>
        `;
    }).join('');
    
    imagesContainer.innerHTML = `
        <div class="edit-images-grid">
            ${imagesHTML}
        </div>
    `;
}

function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
    if (editMap) {
        editMap.remove();
        editMap = null;
        editMarker = null;
    }
}

function initEditMap(lat, lng) {
    // Remove existing map
    if (editMap) {
        editMap.remove();
        editMap = null;
        editMarker = null;
    }
    
    const mapContainer = document.getElementById('edit-map');
    if (!mapContainer) return;
    
    // Set default location or use provided coordinates
    const defaultLat = lat || 40.7128;
    const defaultLng = lng || -74.0060;
    const zoom = (lat && lng) ? 15 : 2;
    
    // Initialize map
    editMap = L.map('edit-map').setView([defaultLat, defaultLng], zoom);
    
    // Add dark tiles to match site theme
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(editMap);
    
    // Add marker if coordinates exist
    if (lat && lng) {
        addEditMarker(lat, lng);
    }
    
    // Click handler to set location
    editMap.on('click', function(e) {
        const { lat, lng } = e.latlng;
        addEditMarker(lat, lng);
        updateCoordinateInputs(lat, lng);
        reverseGeocode(lat, lng);
    });
}

function addEditMarker(lat, lng) {
    if (editMarker) {
        editMap.removeLayer(editMarker);
    }
    
    const coffeeIcon = L.divIcon({
        html: '<div style="background: #d4a574; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0a0a0a; font-size: 16px; box-shadow: 0 2px 6px rgba(212, 165, 116, 0.4);">☕</div>',
        iconSize: [30, 30],
        className: 'coffee-marker'
    });
    
    editMarker = L.marker([lat, lng], { icon: coffeeIcon }).addTo(editMap);
}

function updateCoordinateInputs(lat, lng) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
}

async function reverseGeocode(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
        const data = await response.json();
        
        if (data && data.address) {
            const addr = data.address;
            
            // Auto-fill city
            const city = addr.city || addr.town || addr.village || addr.suburb;
            if (city && !document.getElementById('city').value) {
                document.getElementById('city').value = city;
            }
            
            // Auto-fill country
            if (addr.country && !document.getElementById('country').value) {
                document.getElementById('country').value = addr.country;
            }
            
            // Auto-detect continent
            if (addr.country_code && !document.getElementById('continent').value) {
                const continent = getContinent(addr.country_code);
                if (continent) {
                    document.getElementById('continent').value = continent;
                }
            }
        }
    } catch (error) {
        console.error('Reverse geocoding failed:', error);
    }
}

function getContinent(countryCode) {
    const continents = {
        // North America
        'us': 'North America', 'ca': 'North America', 'mx': 'North America',
        // South America  
        'ar': 'South America', 'cl': 'South America', 'br': 'South America', 'pe': 'South America',
        // Europe
        'gb': 'Europe', 'fr': 'Europe', 'de': 'Europe', 'it': 'Europe', 'es': 'Europe', 'nl': 'Europe',
        // Asia
        'jp': 'Asia', 'cn': 'Asia', 'kr': 'Asia', 'th': 'Asia', 'in': 'Asia',
        // Africa
        'za': 'Africa', 'eg': 'Africa', 'ma': 'Africa',
        // Oceania
        'au': 'Oceania', 'nz': 'Oceania'
    };
    return continents[countryCode.toLowerCase()];
}

function typeaheadSearch(query) {
    // Clear existing timeout
    if (typeaheadTimeout) {
        clearTimeout(typeaheadTimeout);
    }
    
    // Hide typeahead if query is too short
    if (query.length < 3) {
        hideTypeahead();
        return;
    }
    
    // Debounce search
    typeaheadTimeout = setTimeout(() => {
        performTypeaheadSearch(query);
    }, 300);
}

async function performTypeaheadSearch(query) {
    try {
        // Build context from existing form fields
        const context = buildSearchContext();
        
        // Create search queries with context
        const searchQueries = [];
        
        // Primary search with full context
        if (context) {
            searchQueries.push(`${query}, ${context}`);
            searchQueries.push(`${query} cafe, ${context}`);
        }
        
        // Fallback searches without full context
        searchQueries.push(query);
        searchQueries.push(`${query} cafe`);
        
        // Perform searches in parallel
        const searchPromises = searchQueries.map(q => 
            fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&addressdetails=1&limit=3`)
                .then(r => r.json())
                .catch(() => [])
        );
        
        const results = await Promise.all(searchPromises);
        const allResults = results.flat();
        
        // Deduplicate and prioritize results
        const uniqueResults = allResults.filter((result, index, self) => 
            index === self.findIndex(r => r.place_id === result.place_id)
        ).slice(0, 8);
        
        if (uniqueResults.length > 0) {
            currentTypeaheadResults = uniqueResults;
            showTypeaheadResults(uniqueResults);
        } else {
            hideTypeahead();
        }
    } catch (error) {
        console.error('Typeahead search failed:', error);
        hideTypeahead();
    }
}

function showTypeaheadResults(results) {
    const typeaheadDiv = document.getElementById('typeahead-results');
    if (!typeaheadDiv) return;
    
    const resultsHTML = results.map((result, index) => {
        const name = result.display_name.split(',')[0];
        const address = result.display_name.split(',').slice(1, 3).join(',').trim();
        const type = result.type || result.class || '';
        const isCafe = type === 'cafe' || result.class === 'amenity';
        
        return `
            <div class="typeahead-result ${isCafe ? 'cafe-result' : ''}" onclick="selectTypeaheadResult(${index})">
                <div class="typeahead-name">
                    ${isCafe ? '☕ ' : '📍 '}${name}
                </div>
                <div class="typeahead-address">${address}</div>
            </div>
        `;
    }).join('');
    
    typeaheadDiv.innerHTML = resultsHTML;
    typeaheadDiv.style.display = 'block';
}

function hideTypeahead() {
    const typeaheadDiv = document.getElementById('typeahead-results');
    if (typeaheadDiv) {
        typeaheadDiv.style.display = 'none';
    }
    currentTypeaheadResults = [];
}

function navigateTypeahead(direction) {
    const results = document.querySelectorAll('.typeahead-result');
    if (results.length === 0) return;
    
    const current = document.querySelector('.typeahead-result.selected');
    let nextIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(results).indexOf(current);
        if (direction === 'down') {
            nextIndex = (currentIndex + 1) % results.length;
        } else {
            nextIndex = currentIndex === 0 ? results.length - 1 : currentIndex - 1;
        }
        current.classList.remove('selected');
    }
    
    results[nextIndex].classList.add('selected');
}

function selectTypeaheadResult(index) {
    if (!currentTypeaheadResults[index]) return;
    
    const result = currentTypeaheadResults[index];
    const lat = parseFloat(result.lat);
    const lng = parseFloat(result.lon);
    
    // Set the search input to the selected result
    document.getElementById('place-search').value = result.display_name.split(',')[0];
    
    // Set marker and coordinates
    addEditMarker(lat, lng);
    updateCoordinateInputs(lat, lng);
    editMap.setView([lat, lng], 15);
    
    // Auto-fill form fields
    if (result.address) {
        const addr = result.address;
        
        // Extract cafe name if it's a cafe/restaurant
        if (result.type === 'cafe' || result.class === 'amenity') {
            const name = result.display_name.split(',')[0];
            if (!document.getElementById('cafe-name').value) {
                document.getElementById('cafe-name').value = name;
            }
        }
        
        // Fill location fields
        const city = addr.city || addr.town || addr.village || addr.suburb;
        if (city) {
            document.getElementById('city').value = city;
        }
        
        if (addr.country) {
            document.getElementById('country').value = addr.country;
        }
        
        if (addr.country_code) {
            const continent = getContinent(addr.country_code);
            if (continent) {
                document.getElementById('continent').value = continent;
            }
        }
    }
    
    // Hide typeahead
    hideTypeahead();
}

// Helper function to build search context from form fields
function buildSearchContext() {
    const city = document.getElementById('city').value.trim();
    const country = document.getElementById('country').value.trim();
    const continent = document.getElementById('continent').value.trim();
    
    const contextParts = [];
    if (city) contextParts.push(city);
    if (country) contextParts.push(country);
    // Don't include continent in search as it's too broad
    
    return contextParts.join(', ');
}

async function searchPlaces() {
    const query = document.getElementById('place-search').value.trim();
    if (!query) return;
    
    // Hide typeahead and show full results on map
    hideTypeahead();
    
    // Build context from existing form fields
    const context = buildSearchContext();
    
    try {
        // Create multiple search queries with varying levels of context
        const searchQueries = [];
        
        if (context) {
            // Most specific: query with full context
            searchQueries.push(`${query}, ${context}`);
            searchQueries.push(`${query} cafe, ${context}`);
        }
        
        // Less specific: just the query
        searchQueries.push(`${query} cafe`);
        searchQueries.push(query);
        
        // Perform searches in parallel
        const searchPromises = searchQueries.map(q => 
            fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&addressdetails=1&limit=5`)
                .then(r => r.json())
                .catch(() => [])
        );
        
        const results = await Promise.all(searchPromises);
        const allResults = results.flat();
        
        // Deduplicate results
        const uniqueResults = allResults.filter((result, index, self) => 
            index === self.findIndex(r => r.place_id === result.place_id)
        ).slice(0, 10);
        
        if (uniqueResults.length > 0) {
            showSearchResults(uniqueResults);
        } else {
            alert('No results found. Try a different search term.');
        }
    } catch (error) {
        console.error('Places search failed:', error);
        alert('Search failed. Please try again.');
    }
}

function showSearchResults(results) {
    searchResults = results;
    
    // Clear existing markers except the main one
    if (editMap) {
        editMap.eachLayer(layer => {
            if (layer !== editMarker && layer.options && layer.options.searchResult) {
                editMap.removeLayer(layer);
            }
        });
    }
    
    const resultsHTML = results.map((result, index) => {
        const name = result.display_name.split(',')[0];
        const address = result.display_name.split(',').slice(1, 3).join(',');
        return `
            <div class="search-result" onclick="selectSearchResult(${index})">
                <strong>${name}</strong><br>
                <small>${address}</small>
            </div>
        `;
    }).join('');
    
    // Show results in a temporary div
    let resultsDiv = document.getElementById('search-results');
    if (!resultsDiv) {
        resultsDiv = document.createElement('div');
        resultsDiv.id = 'search-results';
        resultsDiv.className = 'search-results';
        document.getElementById('place-search').parentNode.appendChild(resultsDiv);
    }
    
    resultsDiv.innerHTML = resultsHTML;
    resultsDiv.style.display = 'block';
    
    // Add markers to map
    results.forEach((result, index) => {
        const marker = L.marker([result.lat, result.lon], { searchResult: true })
            .addTo(editMap)
            .bindPopup(result.display_name)
            .on('click', () => selectSearchResult(index));
    });
    
    // Fit map to show all results
    if (results.length > 1) {
        const group = new L.featureGroup(
            editMap.getLayers().filter(layer => layer.options && layer.options.searchResult)
        );
        editMap.fitBounds(group.getBounds().pad(0.1));
    } else {
        editMap.setView([results[0].lat, results[0].lon], 15);
    }
}

function selectSearchResult(index) {
    const result = searchResults[index];
    const lat = parseFloat(result.lat);
    const lng = parseFloat(result.lon);
    
    // Set marker and coordinates
    addEditMarker(lat, lng);
    updateCoordinateInputs(lat, lng);
    editMap.setView([lat, lng], 15);
    
    // Auto-fill form fields
    if (result.address) {
        const addr = result.address;
        
        // Extract cafe name if it's a cafe/restaurant
        if (result.type === 'cafe' || result.class === 'amenity') {
            const name = result.display_name.split(',')[0];
            if (!document.getElementById('cafe-name').value) {
                document.getElementById('cafe-name').value = name;
            }
        }
        
        // Fill location fields
        const city = addr.city || addr.town || addr.village || addr.suburb;
        if (city) {
            document.getElementById('city').value = city;
        }
        
        if (addr.country) {
            document.getElementById('country').value = addr.country;
        }
        
        if (addr.country_code) {
            const continent = getContinent(addr.country_code);
            if (continent) {
                document.getElementById('continent').value = continent;
            }
        }
    }
    
    // Hide search results
    const resultsDiv = document.getElementById('search-results');
    if (resultsDiv) {
        resultsDiv.style.display = 'none';
    }
}

function showImageModal(imageUrl, title) {
    // Create modal if it doesn't exist
    let imageModal = document.getElementById('image-modal');
    if (!imageModal) {
        imageModal = document.createElement('div');
        imageModal.id = 'image-modal';
        imageModal.className = 'modal';
        imageModal.innerHTML = `
            <div class="modal-content image-modal-content">
                <div class="modal-header">
                    <h3 id="image-modal-title"></h3>
                    <button class="close-btn" onclick="closeImageModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <img id="image-modal-img" src="" alt="" style="max-width: 100%; height: auto;">
                </div>
            </div>
        `;
        document.body.appendChild(imageModal);
        
        // Close on background click
        imageModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
    }
    
    // Set content and show
    document.getElementById('image-modal-title').textContent = title;
    document.getElementById('image-modal-img').src = imageUrl;
    imageModal.style.display = 'block';
}

function closeImageModal() {
    const imageModal = document.getElementById('image-modal');
    if (imageModal) {
        imageModal.style.display = 'none';
    }
}

function setupEventListeners() {
    // Search
    document.getElementById('search-input').addEventListener('input', filterPosts);
    document.getElementById('continent-filter').addEventListener('change', filterPosts);
    document.getElementById('country-filter').addEventListener('change', filterPosts);
    document.getElementById('show-problematic').addEventListener('click', toggleProblematic);
    
    // Tools buttons
    document.getElementById('export-for-update-btn').addEventListener('click', function() {
        const corrections = localStorage.getItem('coffee-post-corrections');
        if (!corrections || corrections === '{}') {
            alert('No corrections found. Make some edits first!');
            return;
        }
        
        const command = `cd /Users/joegaudet/joedev/worldcoffeetour && python3 update_corrections.py '${corrections}'`;
        document.getElementById('update-command-text').textContent = command;
        
        // Hide other commands, show this one
        document.querySelectorAll('.command-display').forEach(el => el.style.display = 'none');
        document.getElementById('export-command').style.display = 'block';
    });
    
    document.getElementById('apply-corrections-btn').addEventListener('click', function() {
        // Hide other commands, show this one
        document.querySelectorAll('.command-display').forEach(el => el.style.display = 'none');
        document.getElementById('apply-command').style.display = 'block';
    });
    
    document.getElementById('full-reprocess-btn').addEventListener('click', function() {
        // Hide other commands, show this one
        document.querySelectorAll('.command-display').forEach(el => el.style.display = 'none');
        document.getElementById('reprocess-command').style.display = 'block';
    });
    
    // Places search with typeahead
    const placeSearchInput = document.getElementById('place-search');
    
    placeSearchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        typeaheadSearch(query);
    });
    
    placeSearchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideTypeahead();
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateTypeahead('down');
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateTypeahead('up');
        } else if (e.key === 'Enter') {
            e.preventDefault();
            const selected = document.querySelector('.typeahead-result.selected');
            if (selected) {
                const index = Array.from(selected.parentNode.children).indexOf(selected);
                selectTypeaheadResult(index);
            } else {
                searchPlaces();
            }
        }
    });
    
    placeSearchInput.addEventListener('blur', function() {
        // Delay hiding to allow click on results
        setTimeout(hideTypeahead, 200);
    });
    
    placeSearchInput.addEventListener('focus', function() {
        const query = this.value.trim();
        if (query.length >= 3) {
            typeaheadSearch(query);
        }
    });
    
    document.getElementById('search-places-btn').addEventListener('click', searchPlaces);
    
    // Form submission
    document.getElementById('edit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        savePost();
    });
    
    // Close modal on background click
    document.getElementById('edit-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
}

function filterPosts() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const continent = document.getElementById('continent-filter').value;
    const country = document.getElementById('country-filter').value;
    
    console.log('Filtering posts with:', { search, continent, country });
    console.log('Total posts before filtering:', allPosts.length);
    
    let filtered = allPosts;
    
    if (search) {
        filtered = filtered.filter(post => 
            (post.title || '').toLowerCase().includes(search) ||
            (post.cafe_name || '').toLowerCase().includes(search) ||
            (post.city || '').toLowerCase().includes(search) ||
            (post.country || '').toLowerCase().includes(search)
        );
        console.log('After search filter:', filtered.length);
    }
    
    if (continent) {
        filtered = filtered.filter(post => post.continent === continent);
        console.log('After continent filter:', filtered.length);
    }
    
    if (country) {
        filtered = filtered.filter(post => post.country === country);
        console.log('After country filter:', filtered.length);
    }
    
    console.log('Final filtered count:', filtered.length);
    displayPosts(filtered);
    updateStats();
}

function toggleProblematic() {
    const btn = document.getElementById('show-problematic');
    const isShowingProblematic = btn.textContent === 'Show All';
    
    if (isShowingProblematic) {
        btn.textContent = 'Show Problematic Only';
        displayPosts(allPosts);
    } else {
        btn.textContent = 'Show All';
        const problematic = allPosts.filter(post => 
            !post.latitude || !post.longitude || !post.cafe_name
        );
        displayPosts(problematic);
    }
    
    updateStats();
}

function savePost() {
    const form = document.getElementById('edit-form');
    const formData = new FormData(form);
    const postId = formData.get('post-id');
    
    // Create correction object
    const correction = {};
    for (const [key, value] of formData.entries()) {
        if (key !== 'post-id' && value) {
            if (key === 'latitude' || key === 'longitude') {
                correction[key] = parseFloat(value);
            } else {
                correction[key] = value;
            }
        }
    }
    
    // Save correction
    corrections[postId] = correction;
    saveCorrections();
    
    // Update display
    allPosts = coffeePostsData.map(applyCorrections);
    filterPosts();
    closeModal();
    
    alert('Changes saved! The corrections will be preserved when you re-run the script.');
}

function updateStats() {
    const total = filteredPosts.length;
    const noLocation = filteredPosts.filter(p => !p.latitude || !p.longitude).length;
    const noCafe = filteredPosts.filter(p => !p.cafe_name).length;
    
    document.getElementById('total-posts').textContent = total;
    document.getElementById('no-location').textContent = noLocation;
    document.getElementById('no-cafe').textContent = noCafe;
}

// Export corrections function
function exportCorrections() {
    if (Object.keys(corrections).length === 0) {
        alert('No corrections to export! Make some edits first.');
        return;
    }
    
    const dataStr = JSON.stringify(corrections, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'corrections-export.json';
    link.click();
    
    // Show instructions
    setTimeout(() => {
        const instructions = `
Corrections exported! To apply them:

1. The file has been downloaded as 'corrections-export.json'
2. Copy the contents and merge them into 'post-corrections.json' in your project root
3. Re-run the processing script: python3 process_export_enhanced.py
4. Your corrections will be preserved and won't be overwritten

Alternatively, use the export_corrections.py script:
python3 export_corrections.py '${dataStr}'
        `;
        alert(instructions);
    }, 100);
}

// Copy command to clipboard function
function copyCommand(elementId) {
    const commandText = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(commandText).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = '#4ade80';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy. Please select and copy manually.');
    });
}
</script>

<style>
.admin-interface {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.search-filters {
    display: flex;
    gap: 1rem;
    margin: 2rem 0;
    flex-wrap: wrap;
}

.search-input, .filter-select {
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--card-bg);
    color: var(--primary-color);
    font-family: inherit;
}

.search-input {
    flex: 1;
    min-width: 200px;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--accent-color);
    color: var(--bg-color);
}

.btn-secondary {
    background: var(--border-color);
    color: var(--primary-color);
}

.btn-warning {
    background: #ff9500;
    color: white;
}

.btn-small {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
}

.btn:hover {
    opacity: 0.8;
}

.stats {
    margin: 1rem 0;
    padding: 1rem;
    background: var(--card-bg);
    border-radius: 4px;
    color: var(--text-light);
}

.tools-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.tools-section h2 {
    color: var(--accent-color);
    margin: 0 0 1rem 0;
    font-size: 1.2rem;
}

.tool-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.command-display {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(212, 165, 116, 0.1);
    border: 1px solid var(--accent-color);
    border-radius: 4px;
}

.command-display h3 {
    color: var(--accent-color);
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

.command-box {
    display: flex;
    gap: 1rem;
    margin: 0.5rem 0;
    align-items: center;
}

.command-box code {
    flex: 1;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    padding: 0.75rem;
    border-radius: 4px;
    font-family: 'Courier Prime', monospace;
    color: var(--accent-color);
    word-break: break-all;
    font-size: 0.9rem;
}

.command-box .copy-btn {
    background: var(--accent-color);
    color: var(--bg-color);
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.command-display .instructions {
    color: var(--text-light);
    margin: 0.5rem 0 0 0;
    font-size: 0.9rem;
    font-style: italic;
}

.posts-list {
    display: grid;
    gap: 1rem;
}

.post-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    transition: border-color 0.3s ease;
}

.post-item.has-corrections {
    border-left: 4px solid var(--accent-color);
}

.post-item.no-location {
    border-left: 4px solid #ff9500;
}

.post-item.no-cafe {
    border-right: 4px solid #ff6b6b;
}

.post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.post-header h4 {
    margin: 0;
    color: var(--primary-color);
}

.post-badges {
    display: flex;
    gap: 0.5rem;
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge.edited {
    background: var(--accent-color);
    color: var(--bg-color);
}

.badge.warning {
    background: #ff9500;
    color: white;
}

.post-meta {
    display: grid;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: var(--text-light);
    font-size: 0.9rem;
}

.post-actions {
    display: flex;
    gap: 0.5rem;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    margin: 0;
    color: var(--primary-color);
}

.close-btn {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--primary-color);
    font-weight: 500;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-color);
    color: var(--primary-color);
    font-family: inherit;
}

.form-input:focus {
    outline: none;
    border-color: var(--accent-color);
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
}

@media (max-width: 768px) {
    .search-filters {
        flex-direction: column;
    }
    
    .post-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .modal-actions {
        flex-direction: column;
    }
}

/* Post thumbnails */
.post-thumbnail {
    margin: 1rem 0;
    text-align: center;
}

.post-thumbnail img {
    max-width: 200px;
    height: 120px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.post-thumbnail img:hover {
    transform: scale(1.05);
}

/* Edit map */
.edit-map {
    height: 300px;
    width: 100%;
    margin: 1rem 0;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

/* Typeahead results */
.typeahead-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.typeahead-result {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.typeahead-result:hover,
.typeahead-result.selected {
    background: rgba(212, 165, 116, 0.15);
}

.typeahead-result.cafe-result {
    border-left: 3px solid var(--accent-color);
}

.typeahead-result:last-child {
    border-bottom: none;
}

.typeahead-name {
    font-weight: 500;
    color: var(--primary-color);
    font-size: 0.95rem;
}

.typeahead-address {
    color: var(--text-light);
    font-size: 0.85rem;
    opacity: 0.8;
}

/* Search results */
.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.search-result {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
}

.search-result:hover {
    background: rgba(212, 165, 116, 0.1);
}

.search-result:last-child {
    border-bottom: none;
}

/* Image modal */
.image-modal-content {
    max-width: 90vw;
    max-height: 90vh;
}

.image-modal-content .modal-body {
    text-align: center;
    padding: 1rem;
}

/* Form group positioning for search results */
.form-group {
    position: relative;
}

/* Edit images gallery */
.edit-images-gallery {
    margin-bottom: 2rem;
}

.edit-images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.edit-image-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 2px solid var(--border-color);
}

.edit-image-item img:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
    border-color: var(--accent-color);
}

.no-images {
    text-align: center;
    color: var(--text-light);
    font-style: italic;
    margin: 1rem 0;
    padding: 2rem;
    border: 2px dashed var(--border-color);
    border-radius: 4px;
}

@media (max-width: 768px) {
    .edit-map {
        height: 250px;
    }
    
    .post-thumbnail img {
        max-width: 150px;
        height: 90px;
    }
    
    .edit-images-grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }
    
    .edit-image-item img {
        height: 80px;
    }
}
</style>