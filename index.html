---
layout: default
title: World Coffee Tour Map
---


<div class="hero-section">
    <h1 class="hero-title">{{ site.title }}</h1>
    <p class="hero-subtitle">{{ site.description }}</p>
</div>

<div id="map" class="main-map"></div>

<div class="filter-controls">
    <button class="filter-btn active" data-continent="all">All Continents</button>
    <button class="filter-btn" data-continent="north-america">North America</button>
    <button class="filter-btn" data-continent="south-america">South America</button>
    <button class="filter-btn" data-continent="europe">Europe</button>
    <button class="filter-btn" data-continent="asia">Asia</button>
    <button class="filter-btn" data-continent="africa">Africa</button>
    <button class="filter-btn" data-continent="oceania">Oceania</button>
</div>

{% comment %} Filter posts with valid location data {% endcomment %}
{% assign valid_posts = site.coffee_posts %}
{% assign filtered_posts = "" | split: "" %}
{% for post in valid_posts %}
  {% if post.latitude and post.longitude and post.city != "Unknown" and post.country != "Unknown" and post.continent != "World" %}
    {% assign filtered_posts = filtered_posts | push: post %}
  {% endif %}
{% endfor %}
{% assign valid_posts = filtered_posts %}
{% assign posts_by_continent = valid_posts | group_by: 'continent' | sort: 'name' %}

<div class="content-wrapper">
    <div class="posts-content">
        {% for continent in posts_by_continent %}
        <section class="continent-section" id="{{ continent.name | downcase | replace: ' ', '-' }}" data-continent="{{ continent.name | downcase | replace: ' ', '-' }}">
            <h1 class="continent-title">
                <a href="#{{ continent.name | downcase | replace: ' ', '-' }}" class="section-link">{{ continent.name }}</a>
            </h1>
    
    {% assign posts_by_country = continent.items | group_by: 'country' | sort: 'name' %}
    
    {% for country in posts_by_country %}
    <div class="country-section" id="{{ continent.name | downcase | replace: ' ', '-' }}-{{ country.name | downcase | replace: ' ', '-' }}" data-country="{{ country.name }}" data-continent="{{ continent.name }}">
        <h2 class="country-title">
            <a href="#{{ continent.name | downcase | replace: ' ', '-' }}-{{ country.name | downcase | replace: ' ', '-' }}" class="section-link">{{ country.name }}</a>
        </h2>
        
        {% assign posts_by_city = country.items | group_by: 'city' | sort: 'name' %}
        
        {% for city in posts_by_city %}
        <div class="city-section" id="{{ continent.name | downcase | replace: ' ', '-' }}-{{ country.name | downcase | replace: ' ', '-' }}-{{ city.name | downcase | replace: ' ', '-' }}" data-city="{{ city.name }}" data-country="{{ country.name }}" data-continent="{{ continent.name }}">
            <h3 class="city-title">üìç {{ city.name }}</h3>
            
            <div class="coffee-grid">
                {% assign sorted_posts = city.items | sort: 'date' | reverse %}
                {% for post in sorted_posts %}
                <a href="{{ post.url | relative_url }}" class="coffee-card" data-lat="{{ post.latitude }}" data-lng="{{ post.longitude }}">
                    {% if post.image_url %}
                    <img src="{{ post.image_url }}" alt="{{ post.title }}" class="coffee-card-image" loading="lazy">
                    {% else %}
                    <div class="coffee-card-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 3rem;">‚òï</div>
                    {% endif %}
                    <div class="coffee-card-content">
                        {% if post.cafe_name %}
                        <h3 class="coffee-card-title">{{ post.cafe_name }}</h3>
                        {% if post.title %}
                        <p class="coffee-card-description">{{ post.title }}</p>
                        {% endif %}
                        {% else %}
                        <h3 class="coffee-card-title">{{ post.title }}</h3>
                        {% endif %}
                        <div class="coffee-card-meta">
                            {% if post.latitude and post.longitude %}
                            <span class="coffee-card-location">üåç {{ post.latitude | round: 4 }}, {{ post.longitude | round: 4 }}</span>
                            {% endif %}
                            <span>{{ post.date | date: "%b %Y" }}</span>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        
    </div>
    {% endfor %}
        
        </section>
        {% endfor %}
    </div>
</div>

<!-- If no posts yet, show placeholder -->
{% if site.coffee_posts.size == 0 %}
<div class="no-posts">
    <h2>Coffee adventures coming soon...</h2>
    <p>Posts tagged with #worldcoffeetour will appear here</p>
</div>
{% endif %}

<script>
// Pass coffee posts data to JavaScript
const coffeePostsData = [
    {% for post in valid_posts %}
    {
        title: "{{ post.title | escape }}",
        url: "{{ post.url | relative_url }}",
        city: "{{ post.city | escape }}",
        country: "{{ post.country | escape }}",
        continent: "{{ post.continent | escape }}",
        latitude: {{ post.latitude | default: 'null' }},
        longitude: {{ post.longitude | default: 'null' }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
];

// Map functionality
let mainMap;
let isSticky = false;
let currentHoveredCard = null;
let mapContainer = null;
let animationId = null;
let mapOriginalRect = null;
let heroSection = null;
let scrollThreshold = 0;
let scrollEventCount = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Wait for main.js to initialize the map
    const initMainMap = () => {
        if (window.mainMap) {
            mainMap = window.mainMap;
            console.log('mainMap connected:', !!mainMap);
        } else {
            setTimeout(initMainMap, 50);
        }
    };
    initMainMap();
    
    const filterBtns = document.querySelectorAll('.filter-btn');
    const continentSections = document.querySelectorAll('.continent-section');
    const countrySections = document.querySelectorAll('.country-section');
    const contentWrapper = document.querySelector('.content-wrapper');
    
    // Get the main map element and hero section
    mapContainer = document.getElementById('map');
    heroSection = document.querySelector('.hero-section');
    
    // Calculate scroll threshold (when hero section goes out of view)
    function updateScrollThreshold() {
        if (!heroSection || !mapContainer) {
            console.log('updateScrollThreshold early return:', { heroSection: !!heroSection, mapContainer: !!mapContainer });
            return;
        }
        
        const heroRect = heroSection.getBoundingClientRect();
        const mapRect = mapContainer.getBoundingClientRect();
        
        // First calculate the map's original position
        mapOriginalRect = {
            top: mapRect.top + window.scrollY,
            left: mapRect.left,
            width: mapRect.width,
            height: mapRect.height
        };
        
        // Scroll threshold should be when the map intersects with the site header
        // Get the header height to know when the map hits the toolbar
        const siteHeader = document.querySelector('.site-header');
        const headerHeight = siteHeader ? siteHeader.offsetHeight : 0;
        const targetPadding = 100; // The top padding we want for the sticky map
        
        // Animation starts when the map would reach its final sticky position
        // This prevents the map from ever going under the toolbar
        scrollThreshold = mapOriginalRect.top - headerHeight - targetPadding;
        
        console.log('updateScrollThreshold:', { scrollThreshold, mapOriginalRect });
    }
    
    updateScrollThreshold();
    
    // Initialize state based on current scroll position (for page refresh)
    setTimeout(() => {
        updateMapAnimation();
    }, 100);
    
    // Mobile detection
    function isMobileDevice() {
        return window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Listen for scroll events
    let ticking = false;
    window.addEventListener('scroll', () => {
        scrollEventCount++;
        // if (scrollEventCount % 10 === 0) { // Log every 10th scroll event to avoid spam
        //     console.log('Scroll event #', scrollEventCount, 'scrollY:', window.scrollY);
        // }
        
        if (!ticking) {
            requestAnimationFrame(() => {
                if (isMobileDevice()) {
                    updateMapAnimationMobile();
                } else {
                    updateMapAnimation();
                }
                updateBreadcrumb();
                ticking = false;
            });
            ticking = true;
        }
    });
    
    // Update on resize
    window.addEventListener('resize', () => {
        updateScrollThreshold();
        if (isMobileDevice()) {
            updateMapAnimationMobile();
        } else {
            updateMapAnimation();
        }
    });
    
    // Initialize intersection observer for auto-zooming to regions, countries, and cities
    const sectionObserver = new IntersectionObserver(
        (entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && entry.intersectionRatio > 0.3 && isSticky) {
                    zoomToVisibleSection(entry.target);
                }
            });
        },
        { threshold: [0.3], rootMargin: '-50px 0px -40% 0px' }
    );
    
    // Observe continent, country, and city sections for auto-zooming
    continentSections.forEach(section => {
        sectionObserver.observe(section);
    });
    
    countrySections.forEach(section => {
        sectionObserver.observe(section);
    });
    
    // Also observe city sections
    const citySections = document.querySelectorAll('.city-section');
    citySections.forEach(section => {
        sectionObserver.observe(section);
    });
    
    // Card hover functionality - zoom to individual cafe
    document.addEventListener('mouseover', function(e) {
        const card = e.target.closest('.coffee-card');
        if (card && isSticky) {
            const latitude = parseFloat(card.dataset.lat);
            const longitude = parseFloat(card.dataset.lng);
            if (latitude && longitude && mainMap) {
                currentHoveredCard = { lat: latitude, lng: longitude };
                mainMap.setView([latitude, longitude], 16, {animate: true, duration: 0.3, easeLinearity: 0.25});
            }
        }
    });
    
    document.addEventListener('mouseout', function(e) {
        const card = e.target.closest('.coffee-card');
        if (card && currentHoveredCard) {
            currentHoveredCard = null;
            // Return to appropriate section view after a delay
            setTimeout(() => {
                if (!currentHoveredCard && isSticky) {
                    const visibleSection = getMostVisibleSection();
                    if (visibleSection) {
                        if (visibleSection.classList.contains('city-section')) {
                            const cityTitle = visibleSection.querySelector('.city-title');
                            if (cityTitle) {
                                const cityName = cityTitle.textContent.replace('üìç ', '').trim();
                                zoomToCity(cityName);
                            }
                        } else if (visibleSection.classList.contains('country-section')) {
                            zoomToCountry(visibleSection.dataset.country);
                        } else if (visibleSection.classList.contains('continent-section')) {
                            zoomToRegion(visibleSection.dataset.continent);
                        }
                    }
                }
            }, 800);
        }
    });
    
    // Filter functionality
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const continent = this.dataset.continent;
            
            // Update active button
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Show/hide continents
            if (continent === 'all') {
                continentSections.forEach(section => {
                    section.style.display = 'block';
                });
            } else {
                continentSections.forEach(section => {
                    if (section.dataset.continent === continent) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                });
            }
        });
    });
    
});

function updateMapAnimation() {
    if (!mapContainer || !mapOriginalRect) {
        console.log('updateMapAnimation early return:', { mapContainer: !!mapContainer, mapOriginalRect: !!mapOriginalRect });
        return;
    }
    
    const scrollY = window.scrollY;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Calculate progress (0 = hero position, 1 = sidebar position)
    const progress = Math.max(0, Math.min(1, (scrollY - scrollThreshold) / (viewportHeight * 0.3)));
    
    // console.log('updateMapAnimation:', { scrollY, scrollThreshold, progress, isSticky });
    
    // Target dimensions and position
    const targetWidth = Math.min(viewportWidth * 0.35 - 32, 600);
    const targetHeight = targetWidth * (9 / 16); // 16:9 aspect ratio
    const targetTop = 100;
    const targetLeft = viewportWidth - targetWidth - 32;
    
    if (progress > 0) {
        // Animate to sidebar
        if (!isSticky) {
            isSticky = true;
            mapContainer.classList.add('animating');
            // Content wrapper is now always 65% width
            
            // Create placeholder
            if (!document.getElementById('map-placeholder')) {
                const placeholder = document.createElement('div');
                placeholder.id = 'map-placeholder';
                placeholder.style.height = '500px';
                placeholder.style.marginBottom = '3rem';
                placeholder.style.visibility = 'hidden';
                mapContainer.parentNode.insertBefore(placeholder, mapContainer);
            }
            
            if (mainMap) {
                setTimeout(() => {
                    mainMap.invalidateSize();
                    // Only zoom to current section if this isn't the initial page load
                    if (scrollEventCount > 0) {
                        const visibleSection = getMostVisibleSection();
                        if (visibleSection) {
                            zoomToVisibleSection(visibleSection);
                        }
                    }
                }, 100);
            }
        }
        
        // Calculate the natural scroll position of the map (where it would be if not sticky)
        const naturalTop = mapOriginalRect.top - scrollY;
        
        // Ensure the map never goes above its target position (under the toolbar)
        const safeNaturalTop = Math.max(naturalTop, targetTop);
        
        // Interpolate between the safe natural position and the target sticky position
        const currentTop = safeNaturalTop + (targetTop - safeNaturalTop) * progress;
        const currentLeft = mapOriginalRect.left + (targetLeft - mapOriginalRect.left) * progress;
        const currentWidth = mapOriginalRect.width + (targetWidth - mapOriginalRect.width) * progress;
        const currentHeight = mapOriginalRect.height + (targetHeight - mapOriginalRect.height) * progress;
        
        // Apply transform
        mapContainer.style.top = `${currentTop}px`;
        mapContainer.style.left = `${currentLeft}px`;
        mapContainer.style.width = `${currentWidth}px`;
        mapContainer.style.height = `${currentHeight}px`;
        mapContainer.style.borderRadius = `${12 * (1 - progress * 0.5)}px`;
        
        // Update box shadow
        const shadowIntensity = 0.4 + (progress * 0.2);
        mapContainer.style.boxShadow = `0 ${2 + progress * 14}px ${8 + progress * 8}px rgba(0,0,0,${shadowIntensity})`;
        
    } else {
        // Animate back to hero
        if (isSticky) {
            isSticky = false;
            mapContainer.classList.remove('animating');
            // Content wrapper is always 65% width
            
            // Remove placeholder
            const placeholder = document.getElementById('map-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Reset styles
            mapContainer.style.top = '';
            mapContainer.style.left = '';
            mapContainer.style.width = '';
            mapContainer.style.height = '';
            mapContainer.style.borderRadius = '';
            mapContainer.style.boxShadow = '';
            
            if (mainMap) {
                setTimeout(() => {
                    mainMap.invalidateSize();
                    mainMap.setView([20, 0], 2, {animate: true, duration: 0.5});
                }, 100);
            }
        }
    }
}

function updateMapAnimationMobile() {
    const mapContainer = document.getElementById('map-container');
    if (!mapContainer) return;
    
    const scrollY = window.scrollY;
    const scrollThreshold = mapOriginalRect.top - headerHeight - targetPadding;
    
    console.log('Mobile scroll animation - scrollY:', scrollY, 'threshold:', scrollThreshold);
    
    if (scrollY >= scrollThreshold) {
        // Fix map under toolbar
        if (!isSticky) {
            isSticky = true;
            mapContainer.classList.add('mobile-fixed');
            
            // Add stow button if not exists
            if (!document.getElementById('mobile-map-stow')) {
                const stowButton = document.createElement('button');
                stowButton.id = 'mobile-map-stow';
                stowButton.innerHTML = '‚ñº';
                stowButton.className = 'mobile-stow-btn';
                stowButton.onclick = toggleMobileMap;
                mapContainer.appendChild(stowButton);
            }
            
            // Set map to fixed position under toolbar
            mapContainer.style.position = 'fixed';
            mapContainer.style.top = `${headerHeight}px`;
            mapContainer.style.left = '50%';
            mapContainer.style.transform = 'translateX(-50%)';
            mapContainer.style.width = '90%';
            mapContainer.style.maxWidth = '500px';
            mapContainer.style.height = '300px';
            mapContainer.style.zIndex = '100';
            mapContainer.style.borderRadius = '12px';
            mapContainer.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
            mapContainer.style.border = '2px solid var(--border-color)';
            mapContainer.style.background = 'var(--card-bg)';
            
            // Invalidate map size after position change
            if (mainMap) {
                setTimeout(() => mainMap.invalidateSize(), 100);
            }
        }
    } else {
        // Unfix map
        if (isSticky) {
            isSticky = false;
            mapContainer.classList.remove('mobile-fixed', 'mobile-stowed');
            
            // Remove stow button
            const stowButton = document.getElementById('mobile-map-stow');
            if (stowButton) {
                stowButton.remove();
            }
            
            // Reset styles
            mapContainer.style.position = '';
            mapContainer.style.top = '';
            mapContainer.style.left = '';
            mapContainer.style.transform = '';
            mapContainer.style.width = '';
            mapContainer.style.maxWidth = '';
            mapContainer.style.height = '';
            mapContainer.style.zIndex = '';
            mapContainer.style.borderRadius = '';
            mapContainer.style.boxShadow = '';
            mapContainer.style.border = '';
            mapContainer.style.background = '';
            
            if (mainMap) {
                setTimeout(() => mainMap.invalidateSize(), 100);
            }
        }
    }
}

function toggleMobileMap() {
    const mapContainer = document.getElementById('map-container');
    const stowButton = document.getElementById('mobile-map-stow');
    const isStowed = mapContainer.classList.contains('mobile-stowed');
    
    if (isStowed) {
        // Show map
        mapContainer.classList.remove('mobile-stowed');
        mapContainer.style.height = '300px';
        stowButton.innerHTML = '‚ñº';
        if (mainMap) {
            setTimeout(() => mainMap.invalidateSize(), 300);
        }
    } else {
        // Stow map
        mapContainer.classList.add('mobile-stowed');
        mapContainer.style.height = '40px';
        stowButton.innerHTML = '‚ñ≤';
    }
}

function updateBreadcrumb() {
    const visibleSection = getMostVisibleSection();
    const titleContent = document.querySelector('.title-content');
    let breadcrumbNav = document.getElementById('breadcrumb-nav');
    
    if (!titleContent) return;
    
    // Clear breadcrumbs if at the very top of the page
    if (window.scrollY < 100) {
        if (breadcrumbNav) {
            breadcrumbNav.remove();
        }
        titleContent.classList.add('no-breadcrumb');
        return;
    }
    
    if (!visibleSection) return;
    
    const continent = visibleSection.dataset.continent;
    const country = visibleSection.dataset.country;
    const city = visibleSection.dataset.city;
    
    if (continent || country || city) {
        // Create breadcrumb if it doesn't exist
        if (!breadcrumbNav) {
            breadcrumbNav = document.createElement('div');
            breadcrumbNav.id = 'breadcrumb-nav';
            breadcrumbNav.className = 'breadcrumb-nav';
            breadcrumbNav.innerHTML = `
                <a id="breadcrumb-continent" href="#" class="breadcrumb-link"></a>
                <span id="breadcrumb-separator1" class="breadcrumb-separator"> ‚Ä∫ </span>
                <a id="breadcrumb-country" href="#" class="breadcrumb-link"></a>
                <span id="breadcrumb-separator2" class="breadcrumb-separator"> ‚Ä∫ </span>
                <a id="breadcrumb-city" href="#" class="breadcrumb-link"></a>
            `;
            titleContent.appendChild(breadcrumbNav);
        }
        
        // Show breadcrumb with animation
        breadcrumbNav.classList.add('visible');
        titleContent.classList.remove('no-breadcrumb');
        
        // Get the elements
        const continentLink = document.getElementById('breadcrumb-continent');
        const countryLink = document.getElementById('breadcrumb-country');
        const cityLink = document.getElementById('breadcrumb-city');
        const sep1 = document.getElementById('breadcrumb-separator1');
        const sep2 = document.getElementById('breadcrumb-separator2');
        
        // Clear all elements first
        continentLink.textContent = '';
        countryLink.textContent = '';
        cityLink.textContent = '';
        sep1.style.display = 'none';
        sep2.style.display = 'none';
        
        // Update continent
        if (continent) {
            const continentId = continent.toLowerCase().replace(/\s+/g, '-');
            const continentDisplay = continent.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            continentLink.textContent = continentDisplay;
            continentLink.href = `#${continentId}`;
            continentLink.onclick = (e) => {
                e.preventDefault();
                const element = document.getElementById(continentId);
                console.log('Continent click:', continentId, 'element found:', !!element);
                if (element) {
                    const headerHeight = document.querySelector('.site-header').offsetHeight;
                    const elementPosition = element.offsetTop - headerHeight - 20; // 20px extra padding
                    window.scrollTo({ top: elementPosition, behavior: 'smooth' });
                    history.pushState(null, null, `#${continentId}`);
                } else {
                    console.warn('Element not found for continent:', continentId);
                }
            };
        }
        
        // Update country
        if (country && continent) {
            const countryId = `${continent.toLowerCase().replace(/\s+/g, '-')}-${country.toLowerCase().replace(/\s+/g, '-')}`;
            countryLink.textContent = country;
            countryLink.href = `#${countryId}`;
            countryLink.onclick = (e) => {
                e.preventDefault();
                const element = document.getElementById(countryId);
                console.log('Country click:', countryId, 'element found:', !!element);
                if (element) {
                    const headerHeight = document.querySelector('.site-header').offsetHeight;
                    const elementPosition = element.offsetTop - headerHeight - 20; // 20px extra padding
                    window.scrollTo({ top: elementPosition, behavior: 'smooth' });
                    history.pushState(null, null, `#${countryId}`);
                } else {
                    console.warn('Element not found for country:', countryId);
                }
            };
            sep1.style.display = 'inline';
        }
        
        // Update city  
        if (city && country && continent) {
            const cityId = `${continent.toLowerCase().replace(/\s+/g, '-')}-${country.toLowerCase().replace(/\s+/g, '-')}-${city.toLowerCase().replace(/\s+/g, '-')}`;
            cityLink.textContent = city;
            cityLink.href = `#${cityId}`;
            cityLink.onclick = (e) => {
                e.preventDefault();
                const element = document.getElementById(cityId);
                console.log('City click:', cityId, 'element found:', !!element);
                if (element) {
                    const headerHeight = document.querySelector('.site-header').offsetHeight;
                    const elementPosition = element.offsetTop - headerHeight - 20; // 20px extra padding
                    window.scrollTo({ top: elementPosition, behavior: 'smooth' });
                    history.pushState(null, null, `#${cityId}`);
                } else {
                    console.warn('Element not found for city:', cityId);
                }
            };
            sep2.style.display = 'inline';
        }
    } else {
        // Remove breadcrumb entirely
        if (breadcrumbNav) {
            breadcrumbNav.remove();
        }
        titleContent.classList.add('no-breadcrumb');
    }
}

function smoothZoomToBounds(bounds, maxZoom) {
    if (!mainMap) return;
    
    console.log('smoothZoomToBounds called with maxZoom:', maxZoom);
    
    const currentCenter = mainMap.getCenter();
    const targetCenter = bounds.getCenter();
    const currentZoom = mainMap.getZoom();
    const targetZoom = Math.min(mainMap.getBoundsZoom(bounds, [10, 10]), maxZoom || 18);
    
    // Calculate distance to determine if we need to pan first
    const distance = currentCenter.distanceTo(targetCenter);
    const zoomDifference = Math.abs(currentZoom - targetZoom);
    
    console.log('Pan distance:', Math.round(distance), 'km, Zoom difference:', zoomDifference);
    
    // If it's a significant location change, pan first then zoom
    if (distance > 100000 || zoomDifference > 3) { // > 100km or big zoom change
        console.log('Using pan-then-zoom for large distance/zoom change');
        
        // For very long distances (cross-continental), zoom out first, then pan, then zoom in
        if (distance > 5000000 && currentZoom > 4) { // > 5000km and zoomed in
            console.log('Using zoom-out-pan-zoom-in for intercontinental travel');
            
            // First zoom out to see the journey
            mainMap.setZoom(3, {
                animate: true,
                duration: 0.5
            });
            
            // Then pan while zoomed out
            setTimeout(() => {
                mainMap.panTo(targetCenter, {
                    animate: true,
                    duration: 1.0,
                    easeLinearity: 0.1
                });
            }, 300);
            
            // Finally zoom to target
            setTimeout(() => {
                mainMap.fitBounds(bounds, {
                    animate: true,
                    duration: 0.8,
                    easeLinearity: 0.1,
                    maxZoom: maxZoom,
                    padding: [10, 10]
                });
            }, 1100);
            
        } else {
            // Regular pan-then-zoom for shorter distances
            mainMap.panTo(targetCenter, {
                animate: true,
                duration: 0.8,
                easeLinearity: 0.1
            });
            
            // Then zoom after panning
            setTimeout(() => {
                mainMap.fitBounds(bounds, {
                    animate: true,
                    duration: 0.8,
                    easeLinearity: 0.1,
                    maxZoom: maxZoom,
                    padding: [10, 10]
                });
            }, 500);
        }
        
    } else {
        // For nearby locations, use direct fitBounds
        console.log('Using direct fitBounds for nearby location');
        mainMap.fitBounds(bounds, {
            animate: true,
            duration: 0.8,
            easeLinearity: 0.1,
            maxZoom: maxZoom,
            padding: [10, 10]
        });
    }
}

function zoomToVisibleSection(section) {
    if (section.classList.contains('city-section')) {
        const cityTitle = section.querySelector('.city-title');
        if (cityTitle) {
            const cityName = cityTitle.textContent.replace('üìç ', '').trim();
            zoomToCity(cityName);
        }
    } else if (section.classList.contains('country-section')) {
        zoomToCountry(section.dataset.country);
    } else if (section.classList.contains('continent-section')) {
        const continent = section.dataset.continent;
        if (continent) {
            zoomToRegion(continent);
        }
    }
}

function getMostVisibleSection() {
    // Check city sections first (most specific)
    const citySections = document.querySelectorAll('.city-section');
    for (const section of citySections) {
        const rect = section.getBoundingClientRect();
        if (rect.top < window.innerHeight * 0.6 && rect.bottom > window.innerHeight * 0.4) {
            return section;
        }
    }
    
    // Then check country sections
    const countrySections = document.querySelectorAll('.country-section');
    for (const section of countrySections) {
        const rect = section.getBoundingClientRect();
        if (rect.top < window.innerHeight * 0.6 && rect.bottom > window.innerHeight * 0.4) {
            return section;
        }
    }
    
    // Finally check continent sections
    const continentSections = document.querySelectorAll('.continent-section');
    for (const section of continentSections) {
        const rect = section.getBoundingClientRect();
        if (rect.top < window.innerHeight * 0.6 && rect.bottom > window.innerHeight * 0.4) {
            return section;
        }
    }
    
    return null;
}

function zoomToRegion(continent) {
    console.log('zoomToRegion called:', { continent, hasMainMap: !!mainMap, isSticky, currentHoveredCard });
    
    if (!mainMap || !isSticky || currentHoveredCard) return;
    
    const regionPosts = coffeePostsData.filter(post => 
        post.continent.toLowerCase().replace(/\s/g, '-') === continent && 
        post.latitude && post.longitude
    );
    
    console.log('Found region posts:', regionPosts.length, 'for continent:', continent);
    
    if (regionPosts.length > 0) {
        try {
            const group = new L.featureGroup(regionPosts.map(post => 
                L.marker([post.latitude, post.longitude])
            ));
            console.log('Fitting bounds for region');
            smoothZoomToBounds(group.getBounds().pad(0.15), 6);
        } catch (error) {
            console.error('Error during region zoom:', error);
        }
    }
}

function zoomToCountry(country) {
    console.log('zoomToCountry called:', { country, hasMainMap: !!mainMap, isSticky, currentHoveredCard });
    
    if (!mainMap || !isSticky || currentHoveredCard) return;
    
    const countryPosts = coffeePostsData.filter(post => 
        post.country === country && 
        post.latitude && post.longitude
    );
    
    console.log('Found country posts:', countryPosts.length, 'for country:', country);
    
    if (countryPosts.length > 0) {
        try {
            const group = new L.featureGroup(countryPosts.map(post => 
                L.marker([post.latitude, post.longitude])
            ));
            console.log('Fitting bounds for country');
            smoothZoomToBounds(group.getBounds().pad(0.2), 10);
        } catch (error) {
            console.error('Error during country zoom:', error);
        }
    }
}

function zoomToCity(cityName) {
    console.log('zoomToCity called:', { cityName, hasMainMap: !!mainMap, isSticky, currentHoveredCard });
    
    if (!mainMap) {
        console.log('No mainMap - aborting zoom');
        return;
    }
    if (!isSticky) {
        console.log('Not sticky - aborting zoom');
        return;
    }
    if (currentHoveredCard) {
        console.log('Currently hovering card - aborting zoom');
        return;
    }
    
    const cityPosts = coffeePostsData.filter(post => 
        post.city === cityName && 
        post.latitude && post.longitude
    );
    
    console.log('Found city posts:', cityPosts.length, 'for city:', cityName);
    console.log('All city posts:', cityPosts);
    
    if (cityPosts.length > 0) {
        try {
            console.log('Creating markers for city posts...');
            
            // Add small random offsets to identical coordinates so we can see multiple pins
            const markers = cityPosts.map((post, index) => {
                let lat = post.latitude;
                let lng = post.longitude;
                
                // If there are multiple posts and this isn't the first one, add a small offset
                if (cityPosts.length > 1 && index > 0) {
                    // Check if coordinates are identical to first post
                    if (lat === cityPosts[0].latitude && lng === cityPosts[0].longitude) {
                        // Add small random offset (about 100-500m radius)
                        const offsetRange = 0.005; // roughly 500m
                        lat += (Math.random() - 0.5) * offsetRange;
                        lng += (Math.random() - 0.5) * offsetRange;
                        console.log('Added offset to duplicate coordinates for:', post.title);
                    }
                }
                
                console.log('Creating marker for:', lat, lng, post.title);
                return L.marker([lat, lng]);
            });
            
            const group = new L.featureGroup(markers);
            const bounds = group.getBounds();
            console.log('Bounds calculated:', bounds);
            console.log('Bounds northeast:', bounds.getNorthEast());
            console.log('Bounds southwest:', bounds.getSouthWest());
            
            // Use appropriate padding and zoom
            const padding = cityPosts.length === 1 ? 0.01 : 0.1;
            const maxZoom = cityPosts.length === 1 ? 13 : 15;
            
            console.log('Calling fitBounds with padding:', padding, 'maxZoom:', maxZoom);
            
            // Use smooth zoom animation
            smoothZoomToBounds(bounds.pad(padding), maxZoom);
            
            console.log('fitBounds called successfully');
        } catch (error) {
            console.error('Error during zoom:', error);
            console.error('Error stack:', error.stack);
        }
    } else {
        console.log('No posts found for city:', cityName);
    }
}

</script>

<style>
/* Content Layout */
.content-wrapper {
    width: 65%;
    /* Always 65% width, no transition needed */
}

.posts-content {
    width: 100%;
}

@media (max-width: 768px) {
    .content-wrapper {
        width: 100%;
        padding-bottom: 40vh;
    }
    
    #map.sticky-right {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 40vh;
        max-height: 40vh;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 -4px 16px rgba(0,0,0,0.6);
    }
}

/* Mobile map styles */
.mobile-stow-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 12px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 101;
    transition: all 0.2s ease;
}

.mobile-stow-btn:hover {
    background: var(--accent-hover);
    transform: scale(1.1);
}

.mobile-fixed {
    transition: height 0.3s ease, transform 0.3s ease;
}

.mobile-stowed {
    overflow: hidden;
}

.mobile-stowed #map {
    height: 0 !important;
    opacity: 0;
    transition: opacity 0.3s ease;
}

/* Mobile responsive section styling */
@media (max-width: 768px) {
    .country-section {
        margin: 1rem -2rem 2rem -2rem; /* Full bleed */
        border-left: none;
        border-bottom: 3px solid var(--accent-color);
        padding: 0 2rem 1rem 2rem;
    }
    
    .country-title {
        font-size: 1.6rem;
    }
    
    .city-section {
        margin: 1rem -2rem;
        padding: 0 2rem;
        border-left: none;
        border-bottom: 1px solid var(--border-color);
    }
    
    .city-title {
        font-size: 1.2rem;
    }
    
    .continent-title {
        font-size: 1.8rem;
        margin: 2rem -2rem;
        padding: 0 2rem;
    }
    
    /* Make coffee cards full bleed on mobile */
    .coffee-post {
        margin-left: -2rem;
        margin-right: -2rem;
        border-radius: 0;
    }
}

/* Section link styling */
.section-link {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
}

.section-link:hover {
    color: var(--accent-color);
}

/* Site title container for breadcrumb layout */
.site-title-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* Breadcrumb navigation styling - as subheading */
.breadcrumb-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    transform: translateY(-5px);
    margin-top: 0.2rem;
}

.breadcrumb-nav.visible {
    opacity: 1;
    transform: translateY(0);
}

.breadcrumb-link {
    color: var(--text-light);
    text-decoration: none;
    transition: color 0.2s ease;
    font-weight: 400;
}

.breadcrumb-link:hover {
    color: var(--accent-color);
}

.breadcrumb-separator {
    color: var(--accent-color);
    font-size: 0.8rem;
    font-weight: 300;
    opacity: 0.8;
}

@media (max-width: 768px) {
    .breadcrumb-nav {
        font-size: 0.65rem;
        gap: 0.3rem;
    }
    
    .breadcrumb-separator {
        font-size: 0.7rem;
    }
}

.hero-section {
    text-align: center;
    padding: 4rem 2rem 3rem 2rem;
    margin: 0 -2rem;
    position: relative;
    z-index: 1;
    background: var(--bg-color);
    width: calc(100% + 4rem);
}

.hero-title {
    font-size: 3rem;
    font-weight: 300;
    letter-spacing: -1px;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
}

.hero-subtitle {
    color: var(--text-light);
    font-size: 1.1rem;
    max-width: 600px;
    margin: 0 auto;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
}


.coffee-grid {
    position: relative;
    z-index: 1;
}

.region-section {
    position: relative;
    z-index: 1;
}

.filter-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin: 3rem 0;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 0.5rem 1.5rem;
    background: rgba(26, 26, 26, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: 25px;
    color: var(--primary-color);
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}

.filter-btn:hover {
    background: rgba(212, 165, 116, 0.2);
    border-color: var(--accent-color);
}

.filter-btn.active {
    background: var(--accent-color);
    color: var(--bg-color);
    border-color: var(--accent-color);
}

.no-posts {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-light);
}

.no-posts h2 {
    font-weight: 300;
    margin-bottom: 1rem;
}

.continent-title {
    font-size: 2.2rem;
    font-weight: 300;
    color: var(--accent-color);
    margin: 3rem 0 2rem 0;
    text-align: center;
    letter-spacing: -0.5px;
}

.country-section {
    margin: 2rem 0;
    border-left: 3px solid var(--accent-color);
    padding-left: 2rem;
}

.country-title {
    font-size: 1.8rem;
    font-weight: 400;
    color: var(--primary-color);
    margin: 1.5rem 0 1rem 0;
    opacity: 0.9;
}

.city-section {
    margin: 1.5rem 0;
    padding-left: 1rem;
    border-left: 2px solid var(--border-color);
}

.city-title {
    font-size: 1.3rem;
    font-weight: 500;
    color: var(--text-light);
    margin: 1rem 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

@media (max-width: 768px) {
    .hero-title {
        font-size: 2rem;
    }
    
    .filter-controls {
        padding: 0 1rem;
    }
    
    .filter-btn {
        font-size: 0.85rem;
        padding: 0.4rem 1rem;
    }
    
    /* Mobile: remove section borders, zero padding, cards get rounded rects */
    .continent-section,
    .country-section,
    .city-section {
        border: none !important;
        border-left: none !important;
        padding: 0 !important;
        margin: 0 !important;
        background: var(--bg-color);
    }
    
    /* Section headings get padding to align with cards */
    .continent-title,
    .country-title,
    .city-title {
        padding: 0 1em !important;
        margin: 1em 0 !important;
    }
    
    .coffee-card {
        border-radius: 8px !important;
        margin: 1em !important;
    }
}
</style>